{% extends "base_step.html" %}

{% block title %}Location Details - WFM Analytics{% endblock %}

{% block form_content %}
<!-- Location Details Card -->
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card shadow-sm">
            <div class="card-header bg-warning text-dark">
                <h6 class="card-title mb-0">
                    <i class="fas fa-map-marker-alt me-2"></i>Location Details
                </h6>
            </div>
            <div class="card-body">
                <!-- Location Details Availability Section -->
                <div class="mb-4">
                    <div class="form-label fw-bold text-success mb-3">
                        <i class="fas fa-question-circle me-2"></i>Location Details Availability
                    </div>
                    <div class="card border-0 shadow-sm bg-light">
                        <div class="card-body p-4">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label fw-bold text-dark mb-3">
                                        Do you have Location Details?
                                    </label>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="form-check form-check-inline p-3 border rounded bg-white shadow-sm">
                                                <input class="form-check-input" type="radio" name="location-availability" id="location-available" value="available" onchange="toggleLocationDetails()">
                                                <label class="form-check-label fw-bold text-success ms-2" for="location-available">
                                                    <i class="fas fa-check-circle me-2"></i>Available
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check form-check-inline p-3 border rounded bg-white shadow-sm">
                                                <input class="form-check-input" type="radio" name="location-availability" id="location-unavailable" value="unavailable" onchange="toggleLocationDetails()">
                                                <label class="form-check-label fw-bold text-secondary ms-2" for="location-unavailable">
                                                    <i class="fas fa-times-circle me-2"></i>Currently Unavailable
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Location Details Content (Initially Hidden) -->
                <div id="location-details-content" style="display: none;">
                <!-- Country Selection Section -->
                <div class="mb-5">
                    <h6 class="fw-bold text-primary mb-3">
                        <i class="fas fa-globe me-2"></i>Country Selection
                    </h6>
                    <div class="row g-2">
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="geo_country" value="CAN" id="country-can">
                                <label class="form-check-label" for="country-can">Canada</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="geo_country" value="COL" id="country-col">
                                <label class="form-check-label" for="country-col">Colombia</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="geo_country" value="HKG" id="country-hkg">
                                <label class="form-check-label" for="country-hkg">Hong Kong</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="geo_country" value="IND" id="country-ind">
                                <label class="form-check-label" for="country-ind">India</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="geo_country" value="MEX" id="country-mex">
                                <label class="form-check-label" for="country-mex">Mexico</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="geo_country" value="PAN" id="country-pan">
                                <label class="form-check-label" for="country-pan">Panama</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="geo_country" value="PHL" id="country-phl">
                                <label class="form-check-label" for="country-phl">Philippines</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="geo_country" value="POL" id="country-pol">
                                <label class="form-check-label" for="country-pol">Poland</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="geo_country" value="TTO" id="country-tto">
                                <label class="form-check-label" for="country-tto">Trinidad & Tobago</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="geo_country" value="USA" id="country-usa">
                                <label class="form-check-label" for="country-usa">United States</label>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <span class="badge bg-info country-count-display">0 Countries Selected</span>
                    </div>
                </div>

                <!-- Country Distribution Section -->
                <div class="mb-5" id="distribution-section">
                    <h6 class="fw-bold text-info mb-4">
                        <i class="fas fa-users me-2"></i>Country-wise Headcount Distribution
                    </h6>
                    <div class="row g-4" id="country-distribution-grid">
                        <div class="col-lg-4 col-md-6 country-item" data-country="CAN" style="display: none;">
                            <div class="card border-0 shadow-sm h-100 distribution-card">
                                <div class="card-body text-center p-4">
                                    <div class="mb-3">
                                        <i class="fas fa-flag text-danger mb-2" style="font-size: 1.8rem;"></i>
                                        <h6 class="card-title fw-bold text-dark mb-0">Canada</h6>
                                        <small class="text-muted">CAN</small>
                                    </div>
                                    <div class="headcount-input-wrapper">
                                        <label class="form-label small fw-semibold mb-2">Headcount</label>
                                        {{ form.can_headcount(class="form-control form-control-lg country-headcount text-center", placeholder="0", **{"data-country": "CAN"}) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6 country-item" data-country="COL" style="display: none;">
                            <div class="card border-0 shadow-sm h-100 distribution-card">
                                <div class="card-body text-center p-4">
                                    <div class="mb-3">
                                        <i class="fas fa-flag text-warning mb-2" style="font-size: 1.8rem;"></i>
                                        <h6 class="card-title fw-bold text-dark mb-0">Colombia</h6>
                                        <small class="text-muted">COL</small>
                                    </div>
                                    <div class="headcount-input-wrapper">
                                        <label class="form-label small fw-semibold mb-2">Headcount</label>
                                        {{ form.col_headcount(class="form-control form-control-lg country-headcount text-center", placeholder="0", **{"data-country": "COL"}) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6 country-item" data-country="HKG" style="display: none;">
                            <div class="card border-0 shadow-sm h-100 distribution-card">
                                <div class="card-body text-center p-4">
                                    <div class="mb-3">
                                        <i class="fas fa-flag text-danger mb-2" style="font-size: 1.8rem;"></i>
                                        <h6 class="card-title fw-bold text-dark mb-0">Hong Kong</h6>
                                        <small class="text-muted">HKG</small>
                                    </div>
                                    <div class="headcount-input-wrapper">
                                        <label class="form-label small fw-semibold mb-2">Headcount</label>
                                        {{ form.hkg_headcount(class="form-control form-control-lg country-headcount text-center", placeholder="0", **{"data-country": "HKG"}) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6 country-item" data-country="IND" style="display: none;">
                            <div class="card border-0 shadow-sm h-100 distribution-card">
                                <div class="card-body text-center p-4">
                                    <div class="mb-3">
                                        <i class="fas fa-flag text-warning mb-2" style="font-size: 1.8rem;"></i>
                                        <h6 class="card-title fw-bold text-dark mb-0">India</h6>
                                        <small class="text-muted">IND</small>
                                    </div>
                                    <div class="headcount-input-wrapper">
                                        <label class="form-label small fw-semibold mb-2">Headcount</label>
                                        {{ form.ind_headcount(class="form-control form-control-lg country-headcount text-center", placeholder="0", **{"data-country": "IND"}) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6 country-item" data-country="MEX" style="display: none;">
                            <div class="card border-0 shadow-sm h-100 distribution-card">
                                <div class="card-body text-center p-4">
                                    <div class="mb-3">
                                        <i class="fas fa-flag text-success mb-2" style="font-size: 1.8rem;"></i>
                                        <h6 class="card-title fw-bold text-dark mb-0">Mexico</h6>
                                        <small class="text-muted">MEX</small>
                                    </div>
                                    <div class="headcount-input-wrapper">
                                        <label class="form-label small fw-semibold mb-2">Headcount</label>
                                        {{ form.mex_headcount(class="form-control form-control-lg country-headcount text-center", placeholder="0", **{"data-country": "MEX"}) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6 country-item" data-country="PAN" style="display: none;">
                            <div class="card border-0 shadow-sm h-100 distribution-card">
                                <div class="card-body text-center p-4">
                                    <div class="mb-3">
                                        <i class="fas fa-flag text-primary mb-2" style="font-size: 1.8rem;"></i>
                                        <h6 class="card-title fw-bold text-dark mb-0">Panama</h6>
                                        <small class="text-muted">PAN</small>
                                    </div>
                                    <div class="headcount-input-wrapper">
                                        <label class="form-label small fw-semibold mb-2">Headcount</label>
                                        {{ form.pan_headcount(class="form-control form-control-lg country-headcount text-center", placeholder="0", **{"data-country": "PAN"}) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6 country-item" data-country="PHL" style="display: none;">
                            <div class="card border-0 shadow-sm h-100 distribution-card">
                                <div class="card-body text-center p-4">
                                    <div class="mb-3">
                                        <i class="fas fa-flag text-info mb-2" style="font-size: 1.8rem;"></i>
                                        <h6 class="card-title fw-bold text-dark mb-0">Philippines</h6>
                                        <small class="text-muted">PHL</small>
                                    </div>
                                    <div class="headcount-input-wrapper">
                                        <label class="form-label small fw-semibold mb-2">Headcount</label>
                                        {{ form.phl_headcount(class="form-control form-control-lg country-headcount text-center", placeholder="0", **{"data-country": "PHL"}) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6 country-item" data-country="POL" style="display: none;">
                            <div class="card border-0 shadow-sm h-100 distribution-card">
                                <div class="card-body text-center p-4">
                                    <div class="mb-3">
                                        <i class="fas fa-flag text-danger mb-2" style="font-size: 1.8rem;"></i>
                                        <h6 class="card-title fw-bold text-dark mb-0">Poland</h6>
                                        <small class="text-muted">POL</small>
                                    </div>
                                    <div class="headcount-input-wrapper">
                                        <label class="form-label small fw-semibold mb-2">Headcount</label>
                                        {{ form.pol_headcount(class="form-control form-control-lg country-headcount text-center", placeholder="0", **{"data-country": "POL"}) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6 country-item" data-country="TTO" style="display: none;">
                            <div class="card border-0 shadow-sm h-100 distribution-card">
                                <div class="card-body text-center p-4">
                                    <div class="mb-3">
                                        <i class="fas fa-flag text-success mb-2" style="font-size: 1.8rem;"></i>
                                        <h6 class="card-title fw-bold text-dark mb-0">Trinidad & Tobago</h6>
                                        <small class="text-muted">TTO</small>
                                    </div>
                                    <div class="headcount-input-wrapper">
                                        <label class="form-label small fw-semibold mb-2">Headcount</label>
                                        {{ form.tto_headcount(class="form-control form-control-lg country-headcount text-center", placeholder="0", **{"data-country": "TTO"}) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6 country-item" data-country="USA" style="display: none;">
                            <div class="card border-0 shadow-sm h-100 distribution-card">
                                <div class="card-body text-center p-4">
                                    <div class="mb-3">
                                        <i class="fas fa-flag-usa text-primary mb-2" style="font-size: 1.8rem;"></i>
                                        <h6 class="card-title fw-bold text-dark mb-0">United States</h6>
                                        <small class="text-muted">USA</small>
                                    </div>
                                    <div class="headcount-input-wrapper">
                                        <label class="form-label small fw-semibold mb-2">Headcount</label>
                                        {{ form.usa_headcount(class="form-control form-control-lg country-headcount text-center", placeholder="0", **{"data-country": "USA"}) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3" id="no-countries-message" style="display: block;">
                        <div class="alert alert-info text-center">
                            <i class="fas fa-info-circle me-2"></i>
                            Please select countries above to configure headcount distribution.
                        </div>
                    </div>
                </div>

                <!-- Resource Summary Section -->
                <div class="mb-4">
                    <h6 class="fw-bold text-success mb-3">
                        <i class="fas fa-chart-pie me-2"></i>Resource Summary
                    </h6>
                    <div class="resource-summary bg-white border border-light rounded-3 shadow-sm p-3 p-md-4">
                        <!-- KPI Metrics Row -->
                        <div class="row row-cols-1 row-cols-md-3 g-3 mb-4">
                            <div class="col">
                                <div class="d-flex flex-column h-100 text-center">
                                    <div class="kpi-label small text-uppercase text-muted fw-semibold mb-1">Total Allocated</div>
                                    <div class="kpi-value h4 fw-semibold text-dark numeric" id="total-allocated">0</div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="d-flex flex-column h-100 text-center">
                                    <div class="kpi-label small text-uppercase text-muted fw-semibold mb-1">Required</div>
                                    <div class="kpi-value h4 fw-semibold text-dark numeric" id="total-required">0</div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="d-flex flex-column h-100 text-center">
                                    <div class="kpi-label small text-uppercase text-muted fw-semibold mb-1">Balance</div>
                                    <div class="kpi-value h4 fw-semibold numeric" id="balance">0</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Progress Bar Section -->
                        <div class="progress-section">
                            <div class="progress progress-thin mb-2" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                                <div class="progress-bar bg-primary" style="width: 0%" id="allocation-progress"></div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <small class="text-muted fw-medium">Allocation Progress</small>
                                <small class="text-muted fw-medium numeric" id="allocation-percent">0%</small>
                            </div>
                        </div>
                    </div>
                </div>
                </div> <!-- End of location-details-content -->
            </div>
        </div>
        
        <!-- Save Button at End of Form -->
        <div class="text-end mt-3">
            <button type="submit" name="action" value="save" class="btn btn-sm btn-outline-warning" title="Save Progress">
                <i class="fas fa-save me-1" style="font-size: 0.75rem;"></i>Save
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Professional Distribution Card Styling */
.distribution-card {
    transition: all 0.3s ease;
    border: 1px solid #e3e6f0 !important;
    background: #ffffff;
}

.distribution-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
    border-color: #007bff !important;
}

.headcount-input-wrapper {
    position: relative;
}

.country-headcount {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 1.1rem;
    font-weight: 600;
    height: 50px;
    transition: all 0.3s ease;
}

.country-headcount:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.15);
    transform: scale(1.02);
}

.country-headcount::placeholder {
    color: #6c757d;
    font-weight: 400;
}

/* Professional spacing and layout */
#country-distribution-grid {
    margin-bottom: 2rem;
}

.country-item {
    margin-bottom: 1.5rem;
}

/* Alert styling for no countries message */
#no-countries-message .alert {
    border: 2px dashed #6c757d;
    background: #f8f9fa;
    color: #6c757d;
    font-weight: 500;
}

/* Corporate Resource Summary Styling */
.resource-summary {
    background: #ffffff;
    border: 1px solid #e9ecef;
    border-radius: .75rem;
}

.kpi-label {
    font-size: .75rem;
    text-transform: uppercase;
    color: #6c757d;
    letter-spacing: .04em;
}

.kpi-value {
    font-size: 1.5rem;
    line-height: 1.2;
}

.progress-thin {
    height: 10px;
    background: #eef2f6;
    border-radius: 999px;
    overflow: hidden;
}

.progress-thin .progress-bar {
    border-radius: 999px;
    transition: width .3s ease;
}

.numeric {
    font-variant-numeric: tabular-nums;
    letter-spacing: .02em;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Toggle Location Details based on availability selection
function toggleLocationDetails() {
    const selectedRadio = document.querySelector('input[name="location-availability"]:checked');
    const availability = selectedRadio ? selectedRadio.value : '';
    const content = document.getElementById('location-details-content');
    
    if (availability === 'available') {
        content.style.display = 'block';
    } else {
        content.style.display = 'none';
        // Clear all form data when hiding
        document.querySelectorAll('input[name="geo_country"]').forEach(function(checkbox) {
            checkbox.checked = false;
        });
        document.querySelectorAll('.country-headcount').forEach(function(input) {
            input.value = '';
        });
    }
    
    // Update counters when visibility changes
    if (window.updateCountryCount) updateCountryCount();
    if (window.updateResourceSummary) updateResourceSummary();
}

document.addEventListener('DOMContentLoaded', function() {
    // Update country selection count and distribution display
    function updateCountryCount() {
        const checkboxes = document.querySelectorAll('input[name="geo_country"]:checked');
        const countDisplay = document.querySelector('.country-count-display');
        
        if (countDisplay) {
            countDisplay.textContent = `${checkboxes.length} Countries Selected`;
            countDisplay.className = checkboxes.length > 0 ? 'badge bg-success country-count-display' : 'badge bg-info country-count-display';
        }
        
        // Update distribution section visibility
        updateDistributionDisplay();
    }
    
    // Update distribution section based on selected countries
    function updateDistributionDisplay() {
        const checkboxes = document.querySelectorAll('input[name="geo_country"]:checked');
        const selectedCountries = Array.from(checkboxes).map(cb => cb.value);
        const noCountriesMessage = document.getElementById('no-countries-message');
        
        // Hide all country items first
        document.querySelectorAll('.country-item').forEach(function(item) {
            item.style.display = 'none';
        });
        
        // Show selected countries
        selectedCountries.forEach(function(countryCode) {
            const countryItem = document.querySelector(`.country-item[data-country="${countryCode}"]`);
            if (countryItem) {
                countryItem.style.display = 'block';
            }
        });
        
        // Show/hide no countries message
        if (selectedCountries.length === 0) {
            noCountriesMessage.style.display = 'block';
        } else {
            noCountriesMessage.style.display = 'none';
        }
    }
    
    // Add event listeners to country checkboxes
    document.querySelectorAll('input[name="geo_country"]').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            updateCountryCount();
            updateResourceSummary();
        });
    });
    
    // Update resource summary with balance calculation (only for visible countries)
    function updateResourceSummary() {
        // Get the requirement from Step 1 Ramp Details
        const rampRequirementInput = document.getElementById('ramp-requirement-input');
        let totalRequired = 0;
        
        if (rampRequirementInput && rampRequirementInput.value) {
            totalRequired = parseInt(rampRequirementInput.value) || 0;
        } else {
            // Fallback: try to get from session data or use 0 if not available
            const sessionData = window.sessionStorage.getItem('ramp_requirement');
            totalRequired = sessionData ? parseInt(sessionData) : 0;
        }
        
        let totalAllocated = 0;
        document.querySelectorAll('.country-headcount').forEach(function(input) {
            // Only count visible country inputs
            const countryItem = input.closest('.country-item');
            if (countryItem && countryItem.style.display !== 'none') {
                totalAllocated += parseInt(input.value) || 0;
            }
        });
        
        const balance = totalRequired - totalAllocated;
        
        // Format numbers with thousands separator for professional look
        document.getElementById('total-required').textContent = totalRequired.toLocaleString();
        document.getElementById('total-allocated').textContent = totalAllocated.toLocaleString();
        document.getElementById('balance').textContent = Math.abs(balance).toLocaleString() + (balance < 0 ? ' Over' : '');
        
        // Style balance based on value with corporate colors
        const balanceElement = document.getElementById('balance');
        balanceElement.className = 'kpi-value h4 fw-semibold numeric';
        if (balance >= 0) {
            balanceElement.classList.add('text-success');
        } else {
            balanceElement.classList.add('text-danger');
        }
        
        // Calculate percentage for progress bar
        const actualPercentage = totalRequired > 0 ? (totalAllocated / totalRequired) * 100 : 0;
        const displayPercentage = Math.min(actualPercentage, 100);
        
        // Update progress bar
        const progressBar = document.getElementById('allocation-progress');
        const progressContainer = progressBar.closest('.progress');
        const percentElement = document.getElementById('allocation-percent');
        
        progressBar.style.width = `${displayPercentage}%`;
        percentElement.textContent = `${Math.round(actualPercentage)}%`;
        
        // Update ARIA attributes
        progressContainer.setAttribute('aria-valuenow', Math.round(actualPercentage));
        
        // Corporate color coding for progress bar
        progressBar.className = 'progress-bar';
        if (actualPercentage > 100) {
            progressBar.classList.add('bg-danger'); // Over-allocated
        } else if (actualPercentage >= 90) {
            progressBar.classList.add('bg-success'); // Near complete
        } else if (actualPercentage >= 50) {
            progressBar.classList.add('bg-primary'); // Good progress
        } else {
            progressBar.classList.add('bg-info'); // Starting
        }
    }
    
    // Add event listeners to headcount inputs
    document.querySelectorAll('.country-headcount').forEach(function(input) {
        input.addEventListener('input', updateResourceSummary);
    });
    
    // Reset function
    window.resetLocationForm = function() {
        document.querySelectorAll('.country-headcount').forEach(function(input) {
            input.value = '';
        });
        document.querySelectorAll('input[name="geo_country"]').forEach(function(checkbox) {
            checkbox.checked = false;
        });
        updateCountryCount();
        updateResourceSummary();
    };
    
    // Set checkboxes based on server-provided data
    window.preselectedCountries = {{ preselected_countries|tojson|default([]) }};
    const preselected = window.preselectedCountries || [];
    document.querySelectorAll('input[name="geo_country"]').forEach(function(checkbox) {
        checkbox.checked = preselected.includes(checkbox.value);
    });
    
    // Initial updates
    updateCountryCount();
    updateResourceSummary();
});
</script>
{% endblock %}
