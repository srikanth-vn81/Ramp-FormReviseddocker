{% extends "base_step.html" %}

{% block title %}Program Details - WFM Analytics{% endblock %}

{% block form_content %}
<!-- Program Details Availability Section -->
<div class="row mb-4">
    <div class="col-lg-8 mx-auto">
        <div class="mb-4">
            <div class="form-label fw-bold text-success mb-3">
                <i class="fas fa-question-circle me-2"></i>Program Details Availability
            </div>
            <div class="card border-0 shadow-sm bg-light">
                <div class="card-body p-4">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label fw-bold text-dark mb-3">
                                Do you have Program Details?
                            </label>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-check form-check-inline p-3 border rounded bg-white shadow-sm">
                                        <input class="form-check-input" type="radio" name="program-availability" id="program-available" value="available" onchange="toggleProgramDetails()">
                                        <label class="form-check-label fw-bold text-success ms-2" for="program-available">
                                            <i class="fas fa-check-circle me-2"></i>Available
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-check-inline p-3 border rounded bg-white shadow-sm">
                                        <input class="form-check-input" type="radio" name="program-availability" id="program-unavailable" value="unavailable" onchange="toggleProgramDetails()">
                                        <label class="form-check-label fw-bold text-secondary ms-2" for="program-unavailable">
                                            <i class="fas fa-times-circle me-2"></i>Currently Unavailable
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Program Details Content (Initially Hidden) -->
<div id="program-details-content" style="display: none;">
<!-- LOB Details Card -->
<div class="row mb-4" id="lob-details-section">
    <div class="col-lg-8 mx-auto">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="card-title mb-0 fw-bold">
                        <i class="fas fa-building me-2"></i>Business Details
                    </h6>
                    <button type="submit" name="action" value="save" class="btn btn-outline-light" style="padding: 0.25rem; width: 28px; height: 28px; border-radius: 0.375rem; display: inline-flex; align-items: center; justify-content: center;" title="Save">
                        <i class="fas fa-save" style="font-size: 0.8rem;"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">
                            <i class="fas fa-hashtag me-1"></i>LOB Count
                        </label>
                        {{ form.lob_count(class="form-control", placeholder="Enter number of LOBs") }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">
                            <i class="fas fa-edit me-1"></i>LOB Names
                        </label>
                        <input type="text" class="form-control" 
                               id="lob-names-input" 
                               placeholder="Type LOB names separated by commas"
                               style="border: 2px solid #e3e6f0; border-radius: 0.375rem;">
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12">
                        <small class="form-text text-muted" id="lob-info-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Enter LOB names separated by commas. They will appear as checkboxes below.
                        </small>
                        <div id="lob-validation-message" class="mt-2" style="display: none;">
                            <!-- Validation messages will appear here -->
                        </div>
                    </div>
                </div>
                
                <!-- LOB Checkboxes Display -->
                <div class="row mt-4" id="lob-checkboxes-section" style="display: none;">
                    <div class="col-12">
                        <label class="form-label">
                            <i class="fas fa-check-square me-1"></i>Select LOBs for Language & Channel Support
                        </label>
                        
                        <!-- Resource Summary Section -->
                        <div class="card border-0 shadow-sm mb-3" style="background: linear-gradient(135deg, #e8f5e8 0%, #f0f9ff 100%);">
                            <div class="card-body p-3">
                                <div class="row align-items-center">
                                    <div class="col-md-2">
                                        <div class="text-center">
                                            <div class="text-success fw-bold small">
                                                <i class="fas fa-chart-pie me-1"></i>Resource Summary
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-10">
                                        <div class="row text-center">
                                            <div class="col-md-3">
                                                <div class="small text-muted">TOTAL ALLOCATED</div>
                                                <div class="h5 mb-0 text-primary" id="total-allocated">0</div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="small text-muted">REQUIRED</div>
                                                <div class="h5 mb-0 text-dark" id="total-required">200</div>
                                                <input type="hidden" id="required-headcount" value="200">
                                            </div>
                                            <div class="col-md-3">
                                                <div class="small text-muted">BALANCE</div>
                                                <div class="h5 mb-0" id="total-balance">200</div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="small text-muted">Allocation Progress</div>
                                                <div class="progress mt-1" style="height: 8px;">
                                                    <div class="progress-bar bg-success" 
                                                         id="allocation-progress-bar" 
                                                         role="progressbar" 
                                                         style="width: 0%;" 
                                                         aria-valuenow="0" 
                                                         aria-valuemin="0" 
                                                         aria-valuemax="100">
                                                    </div>
                                                </div>
                                                <div class="small text-center mt-1">
                                                    <span id="allocation-percentage">0%</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Validation Messages -->
                                <div id="allocation-validation-message" class="mt-3" style="display: none;">
                                    <!-- Validation messages will appear here -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);">
                            <div class="card-body p-4">
                                <div id="lob-checkboxes-container" class="row g-3">
                                    <!-- Dynamic checkboxes will be generated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Program Details Section (When Available) -->
<div class="row mt-4" id="main-program-details-section" style="display: none;">
    <div class="col-lg-8 mx-auto">
        <div class="card border shadow-sm">
            <div class="card-header bg-primary text-white">
                <h6 class="card-title mb-0 fw-bold">
                    <i class="fas fa-graduation-cap me-2"></i>Program Details
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Training Duration</label>
                        <div class="d-flex gap-2 align-items-center">
                            <div class="flex-shrink-0" style="min-width: 100px;">
                                {{ form.training_duration(class="form-select", id="main-training-duration") }}
                            </div>
                            <div id="main-training-duration-number-container" style="display: none; min-width: 80px;">
                                {{ form.training_duration_number(class="form-select", id="main-training-duration-number") }}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Nesting Duration</label>
                        <div class="d-flex gap-2 align-items-center">
                            <div class="flex-shrink-0" style="min-width: 100px;">
                                {{ form.nesting_duration(class="form-select", id="main-nesting-duration") }}
                            </div>
                            <div id="main-nesting-duration-number-container" style="display: none; min-width: 80px;">
                                {{ form.nesting_duration_number(class="form-select", id="main-nesting-duration-number") }}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Batch Size</label>
                        {{ form.batch_size(class="form-select", id="main-batch-size") }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Additional Training Details Section (Separate) -->
<div class="row mt-4" id="additional-training-section" style="display: none;">
    <div class="col-lg-8 mx-auto">
        <div class="card border shadow-sm">
            <div class="card-header bg-primary text-white">
                <h6 class="card-title mb-0 fw-bold">
                    <i class="fas fa-graduation-cap me-2"></i>Additional Training Details
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Training Duration</label>
                        <div class="d-flex gap-2 align-items-center">
                            <div class="flex-shrink-0" style="min-width: 100px;">
                                {{ form.training_duration(class="form-select") }}
                            </div>
                            <div id="training-duration-number-container" style="display: none; min-width: 80px;">
                                {{ form.training_duration_number(class="form-select") }}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Nesting Duration</label>
                        <div class="d-flex gap-2 align-items-center">
                            <div class="flex-shrink-0" style="min-width: 100px;">
                                {{ form.nesting_duration(class="form-select") }}
                            </div>
                            <div id="nesting-duration-number-container" style="display: none; min-width: 80px;">
                                {{ form.nesting_duration_number(class="form-select") }}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Batch Size</label>
                        {{ form.batch_size(class="form-select") }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Static Language & Channel Support Section -->
<div class="row mt-4" id="language-channel-section" style="display: none;">
    <div class="col-lg-8 mx-auto">
        <div class="card border shadow-sm">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="card-title mb-0 fw-bold">
                        <i class="fas fa-cog me-2"></i>Language & Channel Support
                        <small class="badge bg-light text-primary ms-2" id="selected-lob-badge">Select a LOB</small>
                    </h6>
                    <span class="badge bg-light text-primary">
                        <i class="fas fa-check-circle me-1"></i>Configuration
                    </span>
                </div>
            </div>
            <div class="card-body p-4">
                
                <!-- Language Support Section -->
                <div class="mb-4">
                    <h6 class="mb-3 fw-bold text-dark">
                        <i class="fas fa-globe me-2"></i>Languages Supported
                    </h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            {{ form.languages_supported(class="form-select", id="languages-supported") }}
                        </div>
                        <div class="col-md-6" id="specify-languages-container" style="display: none;">
                            {{ form.specify_languages(class="form-control", id="specify-languages", placeholder="Specify the Languages (e.g., English, Spanish, French)") }}
                        </div>
                    </div>
                </div>
                
                <hr class="my-4">
                
                <!-- Channel Support Section -->
                <div class="channel-support">
                    
                    <!-- Voice Channels -->
                    <div class="mb-4">
                        <h6 class="mb-3 fw-bold text-dark">
                            <i class="fas fa-phone me-2"></i>Voice Channels
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.voice_inbound(class="form-check-input channel-checkbox", id="voice-inbound") }}
                                    <label class="form-check-label" for="voice-inbound">
                                        <span class="icon-wrap"><i class="fas fa-phone-volume text-success"></i></span>Voice - Inbound
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.voice_outbound(class="form-check-input channel-checkbox", id="voice-outbound") }}
                                    <label class="form-check-label" for="voice-outbound">
                                        <span class="icon-wrap"><i class="fas fa-phone-square-alt text-primary"></i></span>Voice - Outbound
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Digital Channels -->
                    <div class="mb-4">
                        <h6 class="mb-3 fw-bold text-dark">
                            <i class="fas fa-desktop me-2"></i>Digital Channels
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.chat(class="form-check-input channel-checkbox", id="chat") }}
                                    <label class="form-check-label" for="chat">
                                        <span class="icon-wrap"><i class="fas fa-comments text-info"></i></span>Chat
                                    </label>
                                </div>
                                <div class="form-check">
                                    {{ form.email(class="form-check-input channel-checkbox", id="email") }}
                                    <label class="form-check-label" for="email">
                                        <span class="icon-wrap"><i class="fas fa-envelope text-warning"></i></span>Email
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.social_sms(class="form-check-input channel-checkbox", id="social-sms") }}
                                    <label class="form-check-label" for="social-sms">
                                        <span class="icon-wrap"><i class="fas fa-share-alt text-danger"></i></span>Social Media/SMS
                                    </label>
                                </div>
                                <div class="form-check">
                                    {{ form.back_office(class="form-check-input channel-checkbox", id="back-office") }}
                                    <label class="form-check-label" for="back-office">
                                        <span class="icon-wrap"><i class="fas fa-cogs text-secondary"></i></span>Back Office
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Others Section -->
                    <div class="mb-3">
                        <div class="form-check">
                            {{ form.others(class="form-check-input", id="others-toggle", onchange="toggleOthersText()") }}
                            <label class="form-check-label" for="others-toggle">
                                <span class="icon-wrap"><i class="fas fa-plus-circle text-muted"></i></span>Others
                            </label>
                        </div>
                        <div id="others-text-container" style="display: none;" class="mt-3">
                            {{ form.others_text(class="form-control", id="others-text", placeholder="Specify other channels...") }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden field to store LOB language and channel data -->
{{ form.lob_language_channel_data(id="lob-language-channel-data") }}
</div> <!-- End of program-details-content -->

{% endblock %}

{% block extra_js %}
<script>
// Global variables
let currentSelectedLob = null;
let lobData = {};

// Toggle Program Details based on availability selection
function toggleProgramDetails() {
    const selectedRadio = document.querySelector('input[name="program-availability"]:checked');
    const availability = selectedRadio ? selectedRadio.value : '';
    const content = document.getElementById('program-details-content');
    const lobSection = document.getElementById('lob-details-section');
    const mainProgramSection = document.getElementById('main-program-details-section');
    const additionalTrainingSection = document.getElementById('additional-training-section');
    const languageChannelSection = document.getElementById('language-channel-section');
    
    if (availability === 'available') {
        // Show all sections for available program
        content.style.display = 'block';
        if (lobSection) lobSection.style.display = 'block';
        if (mainProgramSection) mainProgramSection.style.display = 'block';
        if (additionalTrainingSection) additionalTrainingSection.style.display = 'block';
        if (languageChannelSection) languageChannelSection.style.display = 'block';
        removeMandatoryHighlighting();
    } else if (availability === 'unavailable') {
        // Show only Additional Training Details for unavailable program
        content.style.display = 'block';
        if (lobSection) lobSection.style.display = 'none';
        if (mainProgramSection) mainProgramSection.style.display = 'none';
        if (additionalTrainingSection) additionalTrainingSection.style.display = 'block';
        if (languageChannelSection) languageChannelSection.style.display = 'none';
        
        // Highlight mandatory fields in Additional Training Details
        highlightMandatoryFields();
        
        // Clear LOB and language/channel data only
        clearLobAndChannelData();
    } else {
        // Hide everything if nothing selected
        content.style.display = 'none';
        clearProgramFormData();
    }
}

// Show mandatory fields message for Additional Training Details
function highlightMandatoryFields() {
    // Add a message above the Additional Training Details section
    const additionalTrainingSection = document.getElementById('additional-training-section');
    if (additionalTrainingSection) {
        // Remove any existing message
        const existingMessage = document.getElementById('mandatory-fields-message');
        if (existingMessage) {
            existingMessage.remove();
        }
        
        // Create new message
        const messageDiv = document.createElement('div');
        messageDiv.id = 'mandatory-fields-message';
        messageDiv.className = 'alert alert-info mb-3';
        messageDiv.innerHTML = '<i class="fas fa-info-circle me-2"></i><strong>Please enter the mandatory fields:</strong> Training Duration, Nesting Duration, and Batch Size are required for the unavailable program.';
        
        // Insert before the Additional Training section
        additionalTrainingSection.parentNode.insertBefore(messageDiv, additionalTrainingSection);
    }
    
    // Set fields as required for validation
    const trainingDuration = document.getElementById('training_duration');
    if (trainingDuration) trainingDuration.required = true;
    
    const nestingDuration = document.getElementById('nesting_duration');
    if (nestingDuration) nestingDuration.required = true;
    
    const batchSize = document.getElementById('batch_size');
    if (batchSize) batchSize.required = true;
}

// Remove mandatory field highlighting
function removeMandatoryHighlighting() {
    // Remove the mandatory fields message
    const existingMessage = document.getElementById('mandatory-fields-message');
    if (existingMessage) {
        existingMessage.remove();
    }
    
    // Remove required attribute from fields
    const fields = ['training_duration', 'nesting_duration', 'batch_size'];
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.required = false;
        }
    });
}

// Clear only LOB and channel data (keep training details)
function clearLobAndChannelData() {
    // Clear LOB names input
    const lobNamesInput = document.getElementById('lob-names-input');
    if (lobNamesInput) lobNamesInput.value = '';
    
    // Clear LOB checkboxes
    const lobCheckboxesSection = document.getElementById('lob-checkboxes-section');
    if (lobCheckboxesSection) lobCheckboxesSection.style.display = 'none';
    
    // Clear checkbox container
    const lobCheckboxesContainer = document.getElementById('lob-checkboxes-container');
    if (lobCheckboxesContainer) lobCheckboxesContainer.innerHTML = '';
    
    // Clear language support
    const languagesSupported = document.getElementById('languages-supported');
    if (languagesSupported) languagesSupported.value = '';
    
    // Clear specify languages
    const specifyLanguages = document.getElementById('specify-languages');
    if (specifyLanguages) specifyLanguages.value = '';
    
    // Hide specify languages container
    const specifyContainer = document.getElementById('specify-languages-container');
    if (specifyContainer) specifyContainer.style.display = 'none';
    
    // Clear all channel checkboxes
    clearAllChannelCheckboxes();
    
    // Clear global variables
    currentSelectedLob = null;
    lobData = {};
    
    // Clear hidden form data
    const hiddenField = document.getElementById('lob-language-channel-data');
    if (hiddenField) hiddenField.value = '';
}

// Clear all program form data
function clearProgramFormData() {
    // Clear LOB names input
    const lobNamesInput = document.getElementById('lob-names-input');
    if (lobNamesInput) lobNamesInput.value = '';
    
    // Clear LOB checkboxes
    const lobCheckboxesSection = document.getElementById('lob-checkboxes-section');
    if (lobCheckboxesSection) lobCheckboxesSection.style.display = 'none';
    
    // Clear checkbox container
    const lobCheckboxesContainer = document.getElementById('lob-checkboxes-container');
    if (lobCheckboxesContainer) lobCheckboxesContainer.innerHTML = '';
    
    // Hide additional training and language & channel sections
    const additionalTrainingSection = document.getElementById('additional-training-section');
    if (additionalTrainingSection) additionalTrainingSection.style.display = 'none';
    
    const languageChannelSection = document.getElementById('language-channel-section');
    if (languageChannelSection) languageChannelSection.style.display = 'none';
    
    // Clear language support
    const languagesSupported = document.getElementById('languages-supported');
    if (languagesSupported) languagesSupported.value = '';
    
    // Clear specify languages
    const specifyLanguages = document.getElementById('specify-languages');
    if (specifyLanguages) specifyLanguages.value = '';
    
    // Hide specify languages container
    const specifyContainer = document.getElementById('specify-languages-container');
    if (specifyContainer) specifyContainer.style.display = 'none';
    
    // Clear all channel checkboxes
    clearAllChannelCheckboxes();
    
    // Clear global variables
    currentSelectedLob = null;
    lobData = {};
    
    // Clear hidden form data
    const hiddenField = document.getElementById('lob-language-channel-data');
    if (hiddenField) hiddenField.value = '';
}

// Process LOB names input and generate checkboxes
function processLobNames() {
    const lobNamesInput = document.getElementById('lob-names-input');
    const lobNamesValue = lobNamesInput.value.trim();
    
    // Clear validation message
    hideValidationMessage();
    
    if (!lobNamesValue) {
        // Hide checkboxes section if empty
        const lobCheckboxesSection = document.getElementById('lob-checkboxes-section');
        lobCheckboxesSection.style.display = 'none';
        
        // Hide language & channel section
        const languageChannelSection = document.getElementById('language-channel-section');
        languageChannelSection.style.display = 'none';
        
        // Clear data
        currentSelectedLob = null;
        lobData = {};
        updateFormData();
        updateLobInfoText();
        return;
    }
    
    // Split by comma and clean up
    const lobNames = lobNamesValue.split(',').map(name => name.trim()).filter(name => name.length > 0);
    
    if (lobNames.length === 0) {
        return;
    }
    
    // Validate against LOB count
    if (!validateLobCount(lobNames)) {
        return; // Don't generate checkboxes if validation fails
    }
    
    // Generate checkboxes
    generateLobCheckboxes(lobNames);
}

// Generate LOB checkboxes from the list of names
function generateLobCheckboxes(lobNames) {
    const lobCheckboxesContainer = document.getElementById('lob-checkboxes-container');
    const lobCheckboxesSection = document.getElementById('lob-checkboxes-section');
    
    // Clear existing checkboxes
    lobCheckboxesContainer.innerHTML = '';
    
    // Create checkbox for each LOB
    lobNames.forEach((lobName, index) => {
        const colors = ['primary', 'success', 'info', 'warning', 'danger', 'secondary'];
        const color = colors[index % colors.length];
        const icons = ['fas fa-headset', 'fas fa-tools', 'fas fa-chart-line', 'fas fa-file-invoice-dollar', 'fas fa-hand-holding-usd', 'fas fa-cogs'];
        const icon = icons[index % icons.length];
        
        const checkboxDiv = document.createElement('div');
        checkboxDiv.className = 'col-md-6 col-lg-4';
        checkboxDiv.innerHTML = `
            <div class="card border-0 shadow-sm h-100 lob-card" style="transition: all 0.3s ease;">
                <div class="card-body p-3 text-center">
                    <div class="form-check d-flex align-items-center justify-content-center mb-3">
                        <input class="form-check-input lob-radio me-2" type="radio" name="selected-lob" id="lob-${index}" value="${lobName}" onchange="selectLob('${lobName}')" style="transform: scale(1.2);">
                        <label class="form-check-label fw-bold text-${color}" for="lob-${index}">
                            <i class="${icon} me-2"></i>${lobName}
                        </label>
                    </div>
                    <div class="mt-2">
                        <label class="form-label fw-semibold text-muted small">Headcount</label>
                        <input type="number" 
                               class="form-control form-control-sm text-center lob-headcount" 
                               id="lob-headcount-${index}" 
                               data-lob-name="${lobName}"
                               placeholder="0" 
                               min="0" 
                               style="border: 2px solid #e3e6f0;"
                               onchange="updateLobHeadcount('${lobName}', this.value)"
                               oninput="updateLobHeadcount('${lobName}', this.value)"
                               onclick="event.stopPropagation()">
                    </div>
                </div>
            </div>
        `;
        
        lobCheckboxesContainer.appendChild(checkboxDiv);
    });
    
    // Show checkboxes section
    lobCheckboxesSection.style.display = 'block';
    
    // Clean up obsolete LOB data and initialize new ones
    const newLobData = {};
    lobNames.forEach(lobName => {
        if (lobData[lobName]) {
            // Keep existing data
            newLobData[lobName] = lobData[lobName];
        } else {
            // Initialize new LOB
            newLobData[lobName] = {
                language_support: '',
                specify_languages: '',
                channels: [],
                others_text: '',
                headcount: 0
            };
        }
    });
    
    // Update global lobData to remove obsolete entries
    lobData = newLobData;
    
    // Update Resource Summary after generating LOB cards
    updateResourceSummary();
    
    // If current selected LOB is no longer in the list, clear selection
    if (currentSelectedLob && !lobNames.includes(currentSelectedLob)) {
        currentSelectedLob = null;
        const languageChannelSection = document.getElementById('language-channel-section');
        if (languageChannelSection) languageChannelSection.style.display = 'none';
    }
}

// Update LOB headcount
function updateLobHeadcount(lobName, headcount) {
    // Initialize LOB data if it doesn't exist
    if (!lobData[lobName]) {
        lobData[lobName] = {
            language_support: '',
            specify_languages: '',
            channels: [],
            others_text: '',
            headcount: 0
        };
    }
    
    // Update headcount
    lobData[lobName].headcount = parseInt(headcount) || 0;
    
    // Update Resource Summary
    updateResourceSummary();
    
    // Update form data
    updateFormData();
    
    console.log(`Updated headcount for ${lobName}: ${headcount}`, lobData);
}

// Update Resource Summary validation
function updateResourceSummary() {
    // Calculate total allocated from all LOB headcounts
    let totalAllocated = 0;
    Object.values(lobData).forEach(lob => {
        totalAllocated += lob.headcount || 0;
    });
    
    // Get required value
    const requiredInput = document.getElementById('required-headcount');
    const required = parseInt(requiredInput.value) || 200;
    
    // Calculate balance
    const balance = required - totalAllocated;
    
    // Calculate percentage
    const percentage = required > 0 ? Math.round((totalAllocated / required) * 100) : 0;
    
    // Update display values
    const totalAllocatedEl = document.getElementById('total-allocated');
    const totalBalanceEl = document.getElementById('total-balance');
    const progressBar = document.getElementById('allocation-progress-bar');
    const percentageEl = document.getElementById('allocation-percentage');
    const validationMessageDiv = document.getElementById('allocation-validation-message');
    
    if (totalAllocatedEl) totalAllocatedEl.textContent = totalAllocated;
    if (totalBalanceEl) {
        totalBalanceEl.textContent = balance;
        // Color coding for balance
        if (balance > 0) {
            totalBalanceEl.className = 'h5 mb-0 text-success'; // Green for positive balance (under-allocated)
        } else if (balance < 0) {
            totalBalanceEl.className = 'h5 mb-0 text-danger'; // Red for over-allocation
        } else {
            totalBalanceEl.className = 'h5 mb-0 text-success'; // Green for perfect match
        }
    }
    
    // Update progress bar
    if (progressBar) {
        const clampedPercentage = Math.min(Math.max(percentage, 0), 100);
        progressBar.style.width = clampedPercentage + '%';
        progressBar.setAttribute('aria-valuenow', clampedPercentage);
        
        // Change color based on progress
        progressBar.className = 'progress-bar';
        if (percentage === 100) {
            progressBar.classList.add('bg-success'); // Perfect allocation
        } else if (percentage > 100) {
            progressBar.classList.add('bg-danger'); // Over-allocated
        } else if (percentage >= 75) {
            progressBar.classList.add('bg-info'); // Close to target
        } else if (percentage >= 50) {
            progressBar.classList.add('bg-warning'); // Halfway there
        } else {
            progressBar.classList.add('bg-danger'); // Far from target
        }
    }
    
    if (percentageEl) {
        percentageEl.textContent = percentage + '%';
    }
    
    // Show validation messages
    if (validationMessageDiv) {
        if (balance === 0) {
            // Perfect allocation
            validationMessageDiv.innerHTML = `
                <div class="alert alert-success py-2 mb-0" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Perfect Allocation!</strong> All ${required} headcount positions have been allocated across LOBs.
                </div>
            `;
            validationMessageDiv.style.display = 'block';
        } else if (balance < 0) {
            // Over-allocated
            const overAllocated = Math.abs(balance);
            validationMessageDiv.innerHTML = `
                <div class="alert alert-danger py-2 mb-0" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Over-Allocated!</strong> You have allocated ${overAllocated} more positions than required. Please reduce allocation.
                </div>
            `;
            validationMessageDiv.style.display = 'block';
        } else if (balance > 0) {
            // Under-allocated
            validationMessageDiv.innerHTML = `
                <div class="alert alert-warning py-2 mb-0" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Under-Allocated:</strong> You still need to allocate ${balance} more positions to reach the required ${required} headcount.
                </div>
            `;
            validationMessageDiv.style.display = 'block';
        }
    }
    
    // Update form validation state
    updateFormValidationState(balance === 0);
    
    console.log('Resource Summary Updated:', {
        totalAllocated,
        required,
        balance,
        percentage,
        isValid: balance === 0
    });
}

// Update form validation state - disable/enable form submission
function updateFormValidationState(isValid) {
    // Find all form submit buttons (Save and Next buttons)
    const submitButtons = document.querySelectorAll('button[type="submit"], input[type="submit"], button[name="action"]');
    
    submitButtons.forEach(button => {
        if (!isValid) {
            button.disabled = true;
            button.classList.add('btn-secondary');
            button.classList.remove('btn-primary', 'btn-success');
            button.title = 'Please allocate exactly the required headcount before proceeding';
        } else {
            button.disabled = false;
            button.classList.remove('btn-secondary');
            button.classList.add('btn-primary');
            button.title = '';
        }
    });
    
    // Store validation state globally for form submission check
    window.lobAllocationValid = isValid;
}

// Select a LOB and update the Language & Channel Support section
function selectLob(lobName) {
    // Save current LOB data if there was a previously selected LOB
    if (currentSelectedLob) {
        saveLobData(currentSelectedLob);
    }
    
    // Set new selected LOB
    currentSelectedLob = lobName;
    
    // Show Additional Training Details section first, then Language & Channel Support section
    const additionalTrainingSection = document.getElementById('additional-training-section');
    if (additionalTrainingSection) additionalTrainingSection.style.display = 'block';
    
    const languageChannelSection = document.getElementById('language-channel-section');
    languageChannelSection.style.display = 'block';
    
    // Update selected LOB badge
    const selectedLobBadge = document.getElementById('selected-lob-badge');
    selectedLobBadge.textContent = lobName;
    
    // Load data for this LOB
    loadLobData(lobName);
    
    // Update form data
    updateFormData();
}

// Validate LOB count against entered LOB names
function validateLobCount(lobNames) {
    const lobCountField = document.getElementById('lob_count');
    const lobCount = parseInt(lobCountField.value) || 0;
    const actualCount = lobNames.length;
    
    if (lobCount === 0) {
        showValidationMessage('warning', 'Please enter the LOB Count first to validate your LOB names.');
        return false;
    }
    
    if (actualCount > lobCount) {
        showValidationMessage('danger', `Too many LOB names! You entered ${actualCount} LOBs but specified ${lobCount}. Please remove ${actualCount - lobCount} LOB name(s).`);
        
        // Hide checkboxes section when validation fails
        const lobCheckboxesSection = document.getElementById('lob-checkboxes-section');
        if (lobCheckboxesSection) lobCheckboxesSection.style.display = 'none';
        
        // Hide language & channel section
        const languageChannelSection = document.getElementById('language-channel-section');
        if (languageChannelSection) languageChannelSection.style.display = 'none';
        
        return false;
    }
    
    if (actualCount < lobCount) {
        showValidationMessage('warning', `You need ${lobCount - actualCount} more LOB name(s). You specified ${lobCount} LOBs but only entered ${actualCount}.`);
        return true; // Allow partial entry
    }
    
    // Perfect match
    showValidationMessage('success', `âœ“ Perfect! ${actualCount} LOB names match the specified count.`);
    setTimeout(hideValidationMessage, 3000); // Auto-hide success message
    return true;
}

// Show validation message
function showValidationMessage(type, message) {
    const validationDiv = document.getElementById('lob-validation-message');
    validationDiv.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show py-2" role="alert">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'times-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    validationDiv.style.display = 'block';
}

// Hide validation message
function hideValidationMessage() {
    const validationDiv = document.getElementById('lob-validation-message');
    validationDiv.style.display = 'none';
    validationDiv.innerHTML = '';
}

// Update LOB info text based on count
function updateLobInfoText() {
    const lobCountField = document.getElementById('lob_count');
    const infoText = document.getElementById('lob-info-text');
    const lobCount = parseInt(lobCountField.value) || 0;
    
    if (lobCount > 0) {
        infoText.innerHTML = `
            <i class="fas fa-info-circle me-1"></i>
            Enter exactly ${lobCount} LOB name(s) separated by commas. They will appear as checkboxes below.
        `;
    } else {
        infoText.innerHTML = `
            <i class="fas fa-info-circle me-1"></i>
            Enter LOB names separated by commas. They will appear as checkboxes below.
        `;
    }
}

// Save current form data to the selected LOB
function saveLobData(lobName) {
    if (!lobData[lobName]) {
        lobData[lobName] = {};
    }
    
    // Save language support
    const languagesSupported = document.getElementById('languages-supported');
    lobData[lobName].language_support = languagesSupported.value;
    
    // Save specify languages
    const specifyLanguages = document.getElementById('specify-languages');
    lobData[lobName].specify_languages = specifyLanguages.value;
    
    // Save channel selections
    const channels = [];
    document.querySelectorAll('.channel-checkbox:checked').forEach(checkbox => {
        channels.push(checkbox.id);
    });
    lobData[lobName].channels = channels;
    
    // Save others text
    const othersText = document.getElementById('others-text');
    if (othersText) {
        lobData[lobName].others_text = othersText.value;
    }
    
    // Save headcount (find the headcount input for this LOB)
    const headcountInput = document.querySelector(`input[data-lob-name="${lobName}"]`);
    if (headcountInput) {
        lobData[lobName].headcount = parseInt(headcountInput.value) || 0;
    }
}

// Load data for the selected LOB into the form
function loadLobData(lobName) {
    const data = lobData[lobName] || {
        language_support: '',
        specify_languages: '',
        channels: [],
        others_text: '',
        headcount: 0
    };
    
    // Load language support
    const languagesSupported = document.getElementById('languages-supported');
    languagesSupported.value = data.language_support;
    
    // Show/hide specify languages based on selection
    toggleSpecifyLanguages();
    
    // Load specify languages
    const specifyLanguages = document.getElementById('specify-languages');
    specifyLanguages.value = data.specify_languages;
    
    // Clear all channel checkboxes first
    clearAllChannelCheckboxes();
    
    // Load channel selections
    data.channels.forEach(channelId => {
        const checkbox = document.getElementById(channelId);
        if (checkbox) {
            checkbox.checked = true;
        }
    });
    
    // Load others text
    const othersText = document.getElementById('others-text');
    if (othersText) {
        othersText.value = data.others_text;
    }
    
    // Update others checkbox state
    const othersCheckbox = document.getElementById('others-toggle');
    if (othersCheckbox && data.others_text) {
        othersCheckbox.checked = true;
        toggleOthersText();
    }
    
    // Load headcount value
    const headcountInput = document.querySelector(`input[data-lob-name="${lobName}"]`);
    if (headcountInput) {
        headcountInput.value = data.headcount || 0;
    }
    
    // Update Resource Summary with loaded data
    updateResourceSummary();
    
    // Channel progress removed
}

// Clear all channel checkboxes
function clearAllChannelCheckboxes() {
    document.querySelectorAll('.channel-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Clear others checkbox
    const othersCheckbox = document.getElementById('others-toggle');
    if (othersCheckbox) {
        othersCheckbox.checked = false;
        toggleOthersText();
    }
    
    // Channel progress removed
}

// Toggle specify languages visibility
function toggleSpecifyLanguages() {
    const languageSelect = document.getElementById('languages-supported');
    const specifyContainer = document.getElementById('specify-languages-container');
    
    if (languageSelect && specifyContainer) {
        if (languageSelect.value === 'bilingual' || languageSelect.value === 'multilingual') {
            specifyContainer.style.display = 'block';
        } else {
            specifyContainer.style.display = 'none';
            const specifyInput = document.getElementById('specify-languages');
            if (specifyInput) specifyInput.value = '';
        }
    }
}

// Channel progress tracking removed

// Toggle Others text input
function toggleOthersText() {
    const othersCheckbox = document.getElementById('others-toggle');
    const othersContainer = document.getElementById('others-text-container');
    const othersInput = document.getElementById('others-text');
    
    if (othersCheckbox && othersContainer && othersInput) {
        if (othersCheckbox.checked) {
            othersContainer.style.display = 'block';
        } else {
            othersContainer.style.display = 'none';
            othersInput.value = '';
        }
        
        // Save data if there's a selected LOB
        if (currentSelectedLob) {
            saveLobData(currentSelectedLob);
            updateFormData();
        }
    }
}

// Update the hidden form data with all LOB configurations
function updateFormData() {
    // Save current LOB data before updating
    if (currentSelectedLob) {
        saveLobData(currentSelectedLob);
    }
    
    // Update hidden field
    const hiddenField = document.getElementById('lob-language-channel-data');
    if (hiddenField) {
        hiddenField.value = JSON.stringify(lobData);
    }
    
    console.log('LOB Form Data Updated:', lobData);
}

// Setup Training Duration dropdowns for both sections
function setupTrainingDurationDropdowns() {
    // Main Program Details section dropdowns
    setupDropdownBehavior('main-training-duration', 'main-training-duration-number-container');
    setupDropdownBehavior('main-nesting-duration', 'main-nesting-duration-number-container');
    
    // Additional Training Details section dropdowns
    setupDropdownBehavior('training_duration', 'training-duration-number-container');
    setupDropdownBehavior('nesting_duration', 'nesting-duration-number-container');
}

// Generic function to setup dropdown behavior
function setupDropdownBehavior(selectId, containerIds) {
    const selectElement = document.getElementById(selectId);
    const container = document.getElementById(containerIds);
    
    if (selectElement && container) {
        selectElement.addEventListener('change', function() {
            // Show number input for specific selections (like "Days", "Weeks", etc.)
            if (this.value && this.value !== '' && this.value !== 'Select') {
                // You can customize this logic based on which values should show the number input
                if (this.value.includes('day') || this.value.includes('week') || this.value.includes('month')) {
                    container.style.display = 'block';
                } else {
                    container.style.display = 'none';
                }
            } else {
                container.style.display = 'none';
            }
        });
        
        // Initialize on page load
        if (selectElement.value && selectElement.value !== '' && selectElement.value !== 'Select') {
            if (selectElement.value.includes('day') || selectElement.value.includes('week') || selectElement.value.includes('month')) {
                container.style.display = 'block';
            }
        }
    }
}

// Initialize the form when the page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('WFM Analytics - Program Details Form initialized');
    
    // Check initial program availability state
    const availableRadio = document.getElementById('program-available');
    const unavailableRadio = document.getElementById('program-unavailable');
    
    if (availableRadio && availableRadio.checked) {
        toggleProgramDetails();
    }
    
    // LOB count field listener
    const lobCountField = document.getElementById('lob_count');
    if (lobCountField) {
        lobCountField.addEventListener('input', function() {
            updateLobInfoText();
            hideValidationMessage();
            
            // Re-validate if LOB names are already entered
            const lobNamesInput = document.getElementById('lob-names-input');
            if (lobNamesInput && lobNamesInput.value.trim()) {
                setTimeout(() => {
                    processLobNames();
                }, 100); // Small delay to ensure LOB count is updated
            }
        });
        
        // Initialize info text
        updateLobInfoText();
    }
    
    // LOB names input listener with debounce and real-time validation
    const lobNamesInput = document.getElementById('lob-names-input');
    if (lobNamesInput) {
        let timeout;
        
        // Real-time input validation
        lobNamesInput.addEventListener('input', function() {
            const lobCountField = document.getElementById('lob_count');
            const lobCount = parseInt(lobCountField.value) || 0;
            const currentValue = this.value.trim();
            
            if (lobCount > 0 && currentValue) {
                const currentLobNames = currentValue.split(',').map(name => name.trim()).filter(name => name.length > 0);
                
                // If user tries to enter more than allowed
                if (currentLobNames.length > lobCount) {
                    // Truncate to allowed count
                    const allowedLobNames = currentLobNames.slice(0, lobCount);
                    this.value = allowedLobNames.join(', ');
                    
                    // Show warning message
                    showValidationMessage('warning', `Maximum ${lobCount} LOB names allowed. Additional names were removed.`);
                    setTimeout(hideValidationMessage, 3000);
                }
            }
            
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                processLobNames();
            }, 500); // 500ms debounce
        });
        
        // Prevent pasting too many LOB names
        lobNamesInput.addEventListener('paste', function(e) {
            setTimeout(() => {
                const lobCountField = document.getElementById('lob_count');
                const lobCount = parseInt(lobCountField.value) || 0;
                const currentValue = this.value.trim();
                
                if (lobCount > 0 && currentValue) {
                    const currentLobNames = currentValue.split(',').map(name => name.trim()).filter(name => name.length > 0);
                    
                    if (currentLobNames.length > lobCount) {
                        const allowedLobNames = currentLobNames.slice(0, lobCount);
                        this.value = allowedLobNames.join(', ');
                        
                        showValidationMessage('warning', `Pasted content exceeded ${lobCount} LOB limit. Only first ${lobCount} LOB names were kept.`);
                        setTimeout(hideValidationMessage, 4000);
                        
                        // Trigger processing with corrected value
                        setTimeout(() => {
                            processLobNames();
                        }, 100);
                    }
                }
            }, 10); // Small delay to ensure paste content is processed
        });
    }
    
    // Language support change listener
    const languagesSupported = document.getElementById('languages-supported');
    if (languagesSupported) {
        languagesSupported.addEventListener('change', function() {
            toggleSpecifyLanguages();
            if (currentSelectedLob) {
                saveLobData(currentSelectedLob);
                updateFormData();
            }
        });
    }
    
    // Specify languages input listener
    const specifyLanguages = document.getElementById('specify-languages');
    if (specifyLanguages) {
        specifyLanguages.addEventListener('input', function() {
            if (currentSelectedLob) {
                saveLobData(currentSelectedLob);
                updateFormData();
            }
        });
    }
    
    // Channel checkbox listeners
    document.querySelectorAll('.channel-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (currentSelectedLob) {
                saveLobData(currentSelectedLob);
                updateFormData();
            }
        });
    });
    
    // Others text input listener
    const othersText = document.getElementById('others-text');
    if (othersText) {
        othersText.addEventListener('input', function() {
            if (currentSelectedLob) {
                saveLobData(currentSelectedLob);
                updateFormData();
            }
        });
    }
    
    // Training Duration dropdowns for both sections
    setupTrainingDurationDropdowns();
    
    // Form submission validation
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            // Only validate if LOB checkboxes are visible (program details available)
            const lobCheckboxesSection = document.getElementById('lob-checkboxes-section');
            if (lobCheckboxesSection && lobCheckboxesSection.style.display !== 'none') {
                // Check if allocation is valid
                if (!window.lobAllocationValid) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Scroll to Resource Summary
                    const resourceSummary = document.getElementById('allocation-validation-message');
                    if (resourceSummary) {
                        resourceSummary.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    
                    // Show error message if not already showing
                    updateResourceSummary();
                    
                    alert('Please ensure all headcount positions are properly allocated before proceeding.');
                    return false;
                }
            }
        });
    }
    
    console.log('Program Details form initialized with new LOB input system');
});
</script>

<style>
.lob-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
}

.lob-card .form-check-input:checked {
    background-color: var(--bs-primary);
    border-color: var(--bs-primary);
}

.card-header-bg-effect {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
    pointer-events: none;
}

.channel-checkbox:checked + label {
    font-weight: bold;
    color: var(--bs-primary) !important;
}

.progress {
    background-color: rgba(0,0,0,0.1);
}

.badge {
    font-size: 0.75rem;
}

@media (max-width: 768px) {
    .lob-card {
        margin-bottom: 1rem;
    }
}
</style>

{% endblock %}