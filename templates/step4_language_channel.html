{% extends "base_step.html" %}

{% block title %}Program Details - WFM Analytics{% endblock %}

{% block form_content %}
<!-- Program Details Availability Section -->
<div class="row mb-4">
    <div class="col-lg-8 mx-auto">
        <div class="mb-4">
            <div class="form-label fw-bold text-success mb-3">
                <i class="fas fa-question-circle me-2"></i>Program Details Availability
            </div>
            <div class="card border-0 shadow-sm bg-light">
                <div class="card-body p-4">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label fw-bold text-dark mb-3">
                                Do you have Program Details?
                            </label>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-check form-check-inline p-3 border rounded bg-white shadow-sm">
                                        <input class="form-check-input" type="radio" name="program-availability" id="program-available" value="available" onchange="toggleProgramDetails()">
                                        <label class="form-check-label fw-bold text-success ms-2" for="program-available">
                                            <i class="fas fa-check-circle me-2"></i>Available
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-check-inline p-3 border rounded bg-white shadow-sm">
                                        <input class="form-check-input" type="radio" name="program-availability" id="program-unavailable" value="unavailable" onchange="toggleProgramDetails()">
                                        <label class="form-check-label fw-bold text-secondary ms-2" for="program-unavailable">
                                            <i class="fas fa-times-circle me-2"></i>Currently Unavailable
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Program Details Content (Initially Hidden) -->
<div id="program-details-content" style="display: none;">
<!-- LOB Details Card -->
<div class="row mb-4">
    <div class="col-lg-8 mx-auto">
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-building me-2"></i>LOB Details
                    </h6>
                    <button type="submit" class="btn btn-outline-light" style="padding: 0.25rem; width: 28px; height: 28px; border-radius: 0.375rem; display: inline-flex; align-items: center; justify-content: center;" title="Save">
                        <i class="fas fa-save" style="font-size: 0.8rem;"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-hashtag me-1"></i>LOB Count
                        </label>
                        {{ form.lob_count(class="form-control", placeholder="Enter number of LOBs") }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-edit me-1"></i>LOB Names
                        </label>
                        <input type="text" class="form-control" 
                               id="lob-names-input" 
                               placeholder="Type LOB names separated by commas"
                               style="border: 2px solid #e3e6f0; border-radius: 0.375rem;">
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12">
                        <small class="form-text text-muted" id="lob-info-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Enter LOB names separated by commas. They will appear as checkboxes below.
                        </small>
                        <div id="lob-validation-message" class="mt-2" style="display: none;">
                            <!-- Validation messages will appear here -->
                        </div>
                    </div>
                </div>
                
                <!-- LOB Checkboxes Display -->
                <div class="row mt-4" id="lob-checkboxes-section" style="display: none;">
                    <div class="col-12">
                        <label class="form-label fw-semibold text-primary">
                            <i class="fas fa-check-square me-1"></i>Select LOBs for Language & Channel Support
                        </label>
                        <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);">
                            <div class="card-body p-4">
                                <div id="lob-checkboxes-container" class="row g-3">
                                    <!-- Dynamic checkboxes will be generated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Static Language & Channel Support Section -->
<div class="row mt-4" id="language-channel-section" style="display: none;">
    <div class="col-lg-8 mx-auto">
        <div class="card shadow-lg border-0">
            <div class="card-header bg-primary text-white position-relative overflow-hidden">
                <div class="card-header-bg-effect"></div>
                <div class="d-flex justify-content-between align-items-center position-relative">
                    <h6 class="card-title mb-0 fw-bold">
                        <i class="fas fa-cog me-2"></i>Language & Channel Support
                        <small class="badge bg-light text-primary ms-2 fw-normal" id="selected-lob-badge">Select a LOB</small>
                    </h6>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-white text-primary fw-semibold">
                            <i class="fas fa-check-circle me-1"></i>Configuration
                        </span>
                    </div>
                </div>
            </div>
            <div class="card-body p-4">
                <!-- Language Support Section -->
                <div class="mb-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-dark mb-2">
                                <i class="fas fa-globe me-2 text-primary"></i>Languages Supported
                            </label>
                            {{ form.languages_supported(class="form-select form-select-lg shadow-sm", id="languages-supported") }}
                        </div>
                        <div class="col-md-6" id="specify-languages-container" style="display: none;">
                            <label class="form-label fw-bold text-dark mb-2">Specify the Languages</label>
                            {{ form.specify_languages(class="form-control form-control-lg shadow-sm", id="specify-languages", placeholder="e.g., English, Spanish, French") }}
                        </div>
                    </div>
                </div>
                
                <hr class="my-4 border-2">
                
                <!-- Channel Support Section -->
                <div class="channel-support">
                    <div class="d-flex align-items-center mb-4">
                        <h6 class="fw-bold text-dark mb-0 me-3">
                            <i class="fas fa-headset me-2 text-primary"></i>Channel Support
                        </h6>
                        <div class="flex-grow-1">
                            <div class="progress" style="height: 4px; border-radius: 10px;">
                                <div class="progress-bar bg-primary" style="width: 0%;" id="channel-progress"></div>
                            </div>
                        </div>
                        <small class="text-muted ms-2" id="channel-summary">0 of 6 selected</small>
                    </div>
                    
                    <div class="row g-4">
                        <!-- Voice Channels -->
                        <div class="col-md-6">
                            <div class="card h-100 border-0 shadow-sm" style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);">
                                <div class="card-header bg-light border-0 py-3">
                                    <h6 class="card-title mb-0 fw-bold text-dark">
                                        <i class="fas fa-phone me-2 text-primary"></i>Voice Channels
                                    </h6>
                                </div>
                                <div class="card-body py-3">
                                    <div class="form-check mb-3 p-2 rounded" style="background: rgba(13, 110, 253, 0.1);">
                                        {{ form.voice_inbound(class="form-check-input channel-checkbox", id="voice-inbound") }}
                                        <label class="form-check-label fw-semibold" for="voice-inbound">
                                            <i class="fas fa-phone-volume me-2 text-success"></i>Voice - Inbound
                                        </label>
                                    </div>
                                    <div class="form-check p-2 rounded" style="background: rgba(25, 135, 84, 0.1);">
                                        {{ form.voice_outbound(class="form-check-input channel-checkbox", id="voice-outbound") }}
                                        <label class="form-check-label fw-semibold" for="voice-outbound">
                                            <i class="fas fa-phone-square-alt me-2 text-primary"></i>Voice - Outbound
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Digital Channels -->
                        <div class="col-md-6">
                            <div class="card h-100 border-0 shadow-sm" style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);">
                                <div class="card-header bg-light border-0 py-3">
                                    <h6 class="card-title mb-0 fw-bold text-dark">
                                        <i class="fas fa-desktop me-2 text-info"></i>Digital Channels
                                    </h6>
                                </div>
                                <div class="card-body py-3">
                                    <div class="form-check mb-2 p-2 rounded" style="background: rgba(13, 202, 240, 0.1);">
                                        {{ form.chat(class="form-check-input channel-checkbox", id="chat") }}
                                        <label class="form-check-label fw-semibold" for="chat">
                                            <i class="fas fa-comments me-2 text-info"></i>Chat
                                        </label>
                                    </div>
                                    <div class="form-check mb-2 p-2 rounded" style="background: rgba(255, 193, 7, 0.1);">
                                        {{ form.email(class="form-check-input channel-checkbox", id="email") }}
                                        <label class="form-check-label fw-semibold" for="email">
                                            <i class="fas fa-envelope me-2 text-warning"></i>Email
                                        </label>
                                    </div>
                                    <div class="form-check mb-2 p-2 rounded" style="background: rgba(220, 53, 69, 0.1);">
                                        {{ form.social_sms(class="form-check-input channel-checkbox", id="social-sms") }}
                                        <label class="form-check-label fw-semibold" for="social-sms">
                                            <i class="fas fa-share-alt me-2 text-danger"></i>Social Media/SMS
                                        </label>
                                    </div>
                                    <div class="form-check p-2 rounded" style="background: rgba(108, 117, 125, 0.1);">
                                        {{ form.back_office(class="form-check-input channel-checkbox", id="back-office") }}
                                        <label class="form-check-label fw-semibold" for="back-office">
                                            <i class="fas fa-cogs me-2 text-secondary"></i>Back Office
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Others Section -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);">
                                <div class="card-body p-3">
                                    <div class="form-check mb-2">
                                        {{ form.others(class="form-check-input", id="others-toggle", onchange="toggleOthersText()") }}
                                        <label class="form-check-label fw-semibold" for="others-toggle">
                                            <i class="fas fa-plus-circle me-2 text-muted"></i>Others
                                        </label>
                                    </div>
                                    <div id="others-text-container" style="display: none;" class="mt-3">
                                        {{ form.others_text(class="form-control shadow-sm", id="others-text", placeholder="Specify other channels...") }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden field to store LOB language and channel data -->
{{ form.lob_language_channel_data(id="lob-language-channel-data") }}
</div> <!-- End of program-details-content -->

{% endblock %}

{% block extra_js %}
<script>
// Global variables
let currentSelectedLob = null;
let lobData = {};

// Toggle Program Details based on availability selection
function toggleProgramDetails() {
    const selectedRadio = document.querySelector('input[name="program-availability"]:checked');
    const availability = selectedRadio ? selectedRadio.value : '';
    const content = document.getElementById('program-details-content');
    
    if (availability === 'available') {
        content.style.display = 'block';
    } else {
        content.style.display = 'none';
        // Clear all form data when hiding
        clearProgramFormData();
    }
}

// Clear all program form data
function clearProgramFormData() {
    // Clear LOB names input
    const lobNamesInput = document.getElementById('lob-names-input');
    if (lobNamesInput) lobNamesInput.value = '';
    
    // Clear LOB checkboxes
    const lobCheckboxesSection = document.getElementById('lob-checkboxes-section');
    if (lobCheckboxesSection) lobCheckboxesSection.style.display = 'none';
    
    // Clear checkbox container
    const lobCheckboxesContainer = document.getElementById('lob-checkboxes-container');
    if (lobCheckboxesContainer) lobCheckboxesContainer.innerHTML = '';
    
    // Hide language & channel section
    const languageChannelSection = document.getElementById('language-channel-section');
    if (languageChannelSection) languageChannelSection.style.display = 'none';
    
    // Clear language support
    const languagesSupported = document.getElementById('languages-supported');
    if (languagesSupported) languagesSupported.value = '';
    
    // Clear specify languages
    const specifyLanguages = document.getElementById('specify-languages');
    if (specifyLanguages) specifyLanguages.value = '';
    
    // Hide specify languages container
    const specifyContainer = document.getElementById('specify-languages-container');
    if (specifyContainer) specifyContainer.style.display = 'none';
    
    // Clear all channel checkboxes
    clearAllChannelCheckboxes();
    
    // Clear global variables
    currentSelectedLob = null;
    lobData = {};
    
    // Clear hidden form data
    const hiddenField = document.getElementById('lob-language-channel-data');
    if (hiddenField) hiddenField.value = '';
}

// Process LOB names input and generate checkboxes
function processLobNames() {
    const lobNamesInput = document.getElementById('lob-names-input');
    const lobNamesValue = lobNamesInput.value.trim();
    
    // Clear validation message
    hideValidationMessage();
    
    if (!lobNamesValue) {
        // Hide checkboxes section if empty
        const lobCheckboxesSection = document.getElementById('lob-checkboxes-section');
        lobCheckboxesSection.style.display = 'none';
        
        // Hide language & channel section
        const languageChannelSection = document.getElementById('language-channel-section');
        languageChannelSection.style.display = 'none';
        
        // Clear data
        currentSelectedLob = null;
        lobData = {};
        updateFormData();
        updateLobInfoText();
        return;
    }
    
    // Split by comma and clean up
    const lobNames = lobNamesValue.split(',').map(name => name.trim()).filter(name => name.length > 0);
    
    if (lobNames.length === 0) {
        return;
    }
    
    // Validate against LOB count
    if (!validateLobCount(lobNames)) {
        return; // Don't generate checkboxes if validation fails
    }
    
    // Generate checkboxes
    generateLobCheckboxes(lobNames);
}

// Generate LOB checkboxes from the list of names
function generateLobCheckboxes(lobNames) {
    const lobCheckboxesContainer = document.getElementById('lob-checkboxes-container');
    const lobCheckboxesSection = document.getElementById('lob-checkboxes-section');
    
    // Clear existing checkboxes
    lobCheckboxesContainer.innerHTML = '';
    
    // Create checkbox for each LOB
    lobNames.forEach((lobName, index) => {
        const colors = ['primary', 'success', 'info', 'warning', 'danger', 'secondary'];
        const color = colors[index % colors.length];
        const icons = ['fas fa-headset', 'fas fa-tools', 'fas fa-chart-line', 'fas fa-file-invoice-dollar', 'fas fa-hand-holding-usd', 'fas fa-cogs'];
        const icon = icons[index % icons.length];
        
        const checkboxDiv = document.createElement('div');
        checkboxDiv.className = 'col-md-6 col-lg-4';
        checkboxDiv.innerHTML = `
            <div class="card border-0 shadow-sm h-100 lob-card" style="transition: all 0.3s ease; cursor: pointer;" onclick="selectLob('${lobName}')">
                <div class="card-body p-3 text-center">
                    <div class="form-check d-flex align-items-center justify-content-center">
                        <input class="form-check-input lob-radio me-2" type="radio" name="selected-lob" id="lob-${index}" value="${lobName}" onchange="selectLob('${lobName}')" style="transform: scale(1.2);">
                        <label class="form-check-label fw-bold text-${color}" for="lob-${index}">
                            <i class="${icon} me-2"></i>${lobName}
                        </label>
                    </div>
                </div>
            </div>
        `;
        
        lobCheckboxesContainer.appendChild(checkboxDiv);
    });
    
    // Show checkboxes section
    lobCheckboxesSection.style.display = 'block';
    
    // Clean up obsolete LOB data and initialize new ones
    const newLobData = {};
    lobNames.forEach(lobName => {
        if (lobData[lobName]) {
            // Keep existing data
            newLobData[lobName] = lobData[lobName];
        } else {
            // Initialize new LOB
            newLobData[lobName] = {
                language_support: '',
                specify_languages: '',
                channels: [],
                others_text: ''
            };
        }
    });
    
    // Update global lobData to remove obsolete entries
    lobData = newLobData;
    
    // If current selected LOB is no longer in the list, clear selection
    if (currentSelectedLob && !lobNames.includes(currentSelectedLob)) {
        currentSelectedLob = null;
        const languageChannelSection = document.getElementById('language-channel-section');
        if (languageChannelSection) languageChannelSection.style.display = 'none';
    }
}

// Select a LOB and update the Language & Channel Support section
function selectLob(lobName) {
    // Save current LOB data if there was a previously selected LOB
    if (currentSelectedLob) {
        saveLobData(currentSelectedLob);
    }
    
    // Set new selected LOB
    currentSelectedLob = lobName;
    
    // Show Language & Channel Support section
    const languageChannelSection = document.getElementById('language-channel-section');
    languageChannelSection.style.display = 'block';
    
    // Update selected LOB badge
    const selectedLobBadge = document.getElementById('selected-lob-badge');
    selectedLobBadge.textContent = lobName;
    
    // Load data for this LOB
    loadLobData(lobName);
    
    // Update form data
    updateFormData();
}

// Validate LOB count against entered LOB names
function validateLobCount(lobNames) {
    const lobCountField = document.getElementById('lob_count');
    const lobCount = parseInt(lobCountField.value) || 0;
    const actualCount = lobNames.length;
    
    if (lobCount === 0) {
        showValidationMessage('warning', 'Please enter the LOB Count first to validate your LOB names.');
        return false;
    }
    
    if (actualCount > lobCount) {
        showValidationMessage('danger', `Too many LOB names! You entered ${actualCount} LOBs but specified ${lobCount}. Please remove ${actualCount - lobCount} LOB name(s).`);
        
        // Hide checkboxes section when validation fails
        const lobCheckboxesSection = document.getElementById('lob-checkboxes-section');
        if (lobCheckboxesSection) lobCheckboxesSection.style.display = 'none';
        
        // Hide language & channel section
        const languageChannelSection = document.getElementById('language-channel-section');
        if (languageChannelSection) languageChannelSection.style.display = 'none';
        
        return false;
    }
    
    if (actualCount < lobCount) {
        showValidationMessage('warning', `You need ${lobCount - actualCount} more LOB name(s). You specified ${lobCount} LOBs but only entered ${actualCount}.`);
        return true; // Allow partial entry
    }
    
    // Perfect match
    showValidationMessage('success', `âœ“ Perfect! ${actualCount} LOB names match the specified count.`);
    setTimeout(hideValidationMessage, 3000); // Auto-hide success message
    return true;
}

// Show validation message
function showValidationMessage(type, message) {
    const validationDiv = document.getElementById('lob-validation-message');
    validationDiv.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show py-2" role="alert">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'times-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    validationDiv.style.display = 'block';
}

// Hide validation message
function hideValidationMessage() {
    const validationDiv = document.getElementById('lob-validation-message');
    validationDiv.style.display = 'none';
    validationDiv.innerHTML = '';
}

// Update LOB info text based on count
function updateLobInfoText() {
    const lobCountField = document.getElementById('lob_count');
    const infoText = document.getElementById('lob-info-text');
    const lobCount = parseInt(lobCountField.value) || 0;
    
    if (lobCount > 0) {
        infoText.innerHTML = `
            <i class="fas fa-info-circle me-1"></i>
            Enter exactly ${lobCount} LOB name(s) separated by commas. They will appear as checkboxes below.
        `;
    } else {
        infoText.innerHTML = `
            <i class="fas fa-info-circle me-1"></i>
            Enter LOB names separated by commas. They will appear as checkboxes below.
        `;
    }
}

// Save current form data to the selected LOB
function saveLobData(lobName) {
    if (!lobData[lobName]) {
        lobData[lobName] = {};
    }
    
    // Save language support
    const languagesSupported = document.getElementById('languages-supported');
    lobData[lobName].language_support = languagesSupported.value;
    
    // Save specify languages
    const specifyLanguages = document.getElementById('specify-languages');
    lobData[lobName].specify_languages = specifyLanguages.value;
    
    // Save channel selections
    const channels = [];
    document.querySelectorAll('.channel-checkbox:checked').forEach(checkbox => {
        channels.push(checkbox.id);
    });
    lobData[lobName].channels = channels;
    
    // Save others text
    const othersText = document.getElementById('others-text');
    if (othersText) {
        lobData[lobName].others_text = othersText.value;
    }
}

// Load data for the selected LOB into the form
function loadLobData(lobName) {
    const data = lobData[lobName] || {
        language_support: '',
        specify_languages: '',
        channels: [],
        others_text: ''
    };
    
    // Load language support
    const languagesSupported = document.getElementById('languages-supported');
    languagesSupported.value = data.language_support;
    
    // Show/hide specify languages based on selection
    toggleSpecifyLanguages();
    
    // Load specify languages
    const specifyLanguages = document.getElementById('specify-languages');
    specifyLanguages.value = data.specify_languages;
    
    // Clear all channel checkboxes first
    clearAllChannelCheckboxes();
    
    // Load channel selections
    data.channels.forEach(channelId => {
        const checkbox = document.getElementById(channelId);
        if (checkbox) {
            checkbox.checked = true;
        }
    });
    
    // Load others text
    const othersText = document.getElementById('others-text');
    if (othersText) {
        othersText.value = data.others_text;
    }
    
    // Update others checkbox state
    const othersCheckbox = document.getElementById('others-toggle');
    if (othersCheckbox && data.others_text) {
        othersCheckbox.checked = true;
        toggleOthersText();
    }
    
    // Update channel progress
    updateChannelProgress();
}

// Clear all channel checkboxes
function clearAllChannelCheckboxes() {
    document.querySelectorAll('.channel-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Clear others checkbox
    const othersCheckbox = document.getElementById('others-toggle');
    if (othersCheckbox) {
        othersCheckbox.checked = false;
        toggleOthersText();
    }
    
    // Update progress
    updateChannelProgress();
}

// Toggle specify languages visibility
function toggleSpecifyLanguages() {
    const languageSelect = document.getElementById('languages-supported');
    const specifyContainer = document.getElementById('specify-languages-container');
    
    if (languageSelect && specifyContainer) {
        if (languageSelect.value === 'bilingual' || languageSelect.value === 'multilingual') {
            specifyContainer.style.display = 'block';
        } else {
            specifyContainer.style.display = 'none';
            const specifyInput = document.getElementById('specify-languages');
            if (specifyInput) specifyInput.value = '';
        }
    }
}

// Update channel progress
function updateChannelProgress() {
    const totalChannels = 6; // Total possible channels (excluding others)
    const checkedChannels = document.querySelectorAll('.channel-checkbox:checked').length;
    const progressBar = document.getElementById('channel-progress');
    const channelSummary = document.getElementById('channel-summary');
    
    if (progressBar) {
        const percentage = (checkedChannels / totalChannels) * 100;
        progressBar.style.width = percentage + '%';
    }
    
    if (channelSummary) {
        channelSummary.textContent = `${checkedChannels} of ${totalChannels} selected`;
    }
}

// Toggle Others text input
function toggleOthersText() {
    const othersCheckbox = document.getElementById('others-toggle');
    const othersContainer = document.getElementById('others-text-container');
    const othersInput = document.getElementById('others-text');
    
    if (othersCheckbox && othersContainer && othersInput) {
        if (othersCheckbox.checked) {
            othersContainer.style.display = 'block';
        } else {
            othersContainer.style.display = 'none';
            othersInput.value = '';
        }
        
        // Save data if there's a selected LOB
        if (currentSelectedLob) {
            saveLobData(currentSelectedLob);
            updateFormData();
        }
    }
}

// Update the hidden form data with all LOB configurations
function updateFormData() {
    // Save current LOB data before updating
    if (currentSelectedLob) {
        saveLobData(currentSelectedLob);
    }
    
    // Update hidden field
    const hiddenField = document.getElementById('lob-language-channel-data');
    if (hiddenField) {
        hiddenField.value = JSON.stringify(lobData);
    }
    
    console.log('LOB Form Data Updated:', lobData);
}

// Initialize the form when the page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('WFM Analytics - Program Details Form initialized');
    
    // Check initial program availability state
    const availableRadio = document.getElementById('program-available');
    const unavailableRadio = document.getElementById('program-unavailable');
    
    if (availableRadio && availableRadio.checked) {
        toggleProgramDetails();
    }
    
    // LOB count field listener
    const lobCountField = document.getElementById('lob_count');
    if (lobCountField) {
        lobCountField.addEventListener('input', function() {
            updateLobInfoText();
            hideValidationMessage();
            
            // Re-validate if LOB names are already entered
            const lobNamesInput = document.getElementById('lob-names-input');
            if (lobNamesInput && lobNamesInput.value.trim()) {
                setTimeout(() => {
                    processLobNames();
                }, 100); // Small delay to ensure LOB count is updated
            }
        });
        
        // Initialize info text
        updateLobInfoText();
    }
    
    // LOB names input listener with debounce and real-time validation
    const lobNamesInput = document.getElementById('lob-names-input');
    if (lobNamesInput) {
        let timeout;
        
        // Real-time input validation
        lobNamesInput.addEventListener('input', function() {
            const lobCountField = document.getElementById('lob_count');
            const lobCount = parseInt(lobCountField.value) || 0;
            const currentValue = this.value.trim();
            
            if (lobCount > 0 && currentValue) {
                const currentLobNames = currentValue.split(',').map(name => name.trim()).filter(name => name.length > 0);
                
                // If user tries to enter more than allowed
                if (currentLobNames.length > lobCount) {
                    // Truncate to allowed count
                    const allowedLobNames = currentLobNames.slice(0, lobCount);
                    this.value = allowedLobNames.join(', ');
                    
                    // Show warning message
                    showValidationMessage('warning', `Maximum ${lobCount} LOB names allowed. Additional names were removed.`);
                    setTimeout(hideValidationMessage, 3000);
                }
            }
            
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                processLobNames();
            }, 500); // 500ms debounce
        });
        
        // Prevent pasting too many LOB names
        lobNamesInput.addEventListener('paste', function(e) {
            setTimeout(() => {
                const lobCountField = document.getElementById('lob_count');
                const lobCount = parseInt(lobCountField.value) || 0;
                const currentValue = this.value.trim();
                
                if (lobCount > 0 && currentValue) {
                    const currentLobNames = currentValue.split(',').map(name => name.trim()).filter(name => name.length > 0);
                    
                    if (currentLobNames.length > lobCount) {
                        const allowedLobNames = currentLobNames.slice(0, lobCount);
                        this.value = allowedLobNames.join(', ');
                        
                        showValidationMessage('warning', `Pasted content exceeded ${lobCount} LOB limit. Only first ${lobCount} LOB names were kept.`);
                        setTimeout(hideValidationMessage, 4000);
                        
                        // Trigger processing with corrected value
                        setTimeout(() => {
                            processLobNames();
                        }, 100);
                    }
                }
            }, 10); // Small delay to ensure paste content is processed
        });
    }
    
    // Language support change listener
    const languagesSupported = document.getElementById('languages-supported');
    if (languagesSupported) {
        languagesSupported.addEventListener('change', function() {
            toggleSpecifyLanguages();
            if (currentSelectedLob) {
                saveLobData(currentSelectedLob);
                updateFormData();
            }
        });
    }
    
    // Specify languages input listener
    const specifyLanguages = document.getElementById('specify-languages');
    if (specifyLanguages) {
        specifyLanguages.addEventListener('input', function() {
            if (currentSelectedLob) {
                saveLobData(currentSelectedLob);
                updateFormData();
            }
        });
    }
    
    // Channel checkbox listeners
    document.querySelectorAll('.channel-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateChannelProgress();
            if (currentSelectedLob) {
                saveLobData(currentSelectedLob);
                updateFormData();
            }
        });
    });
    
    // Others text input listener
    const othersText = document.getElementById('others-text');
    if (othersText) {
        othersText.addEventListener('input', function() {
            if (currentSelectedLob) {
                saveLobData(currentSelectedLob);
                updateFormData();
            }
        });
    }
    
    console.log('Program Details form initialized with new LOB input system');
});
</script>

<style>
.lob-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
}

.lob-card .form-check-input:checked {
    background-color: var(--bs-primary);
    border-color: var(--bs-primary);
}

.card-header-bg-effect {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
    pointer-events: none;
}

.channel-checkbox:checked + label {
    font-weight: bold;
    color: var(--bs-primary) !important;
}

.progress {
    background-color: rgba(0,0,0,0.1);
}

.badge {
    font-size: 0.75rem;
}

@media (max-width: 768px) {
    .lob-card {
        margin-bottom: 1rem;
    }
}
</style>

{% endblock %}