{% extends "base_step.html" %}

{% block title %}Program Details - WFM Analytics{% endblock %}

{% block form_content %}
<!-- LOB Details Card -->
<div class="row mb-4">
    <div class="col-lg-8 mx-auto">
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h6 class="card-title mb-0">
                    <i class="fas fa-building me-2"></i>LOB Details
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-hashtag me-1"></i>LOB Count
                        </label>
                        {{ form.lob_count(class="form-control", placeholder="Enter number of LOBs") }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-list-ul me-1"></i>LOB Names
                        </label>
                        <div class="dropdown">
                            <button class="form-control dropdown-toggle d-flex justify-content-between align-items-center text-start" 
                                    type="button" 
                                    id="lob-dropdown-toggle" 
                                    data-bs-toggle="dropdown" 
                                    aria-expanded="false"
                                    style="background: #ffffff; border: 1px solid #ced4da; border-radius: 0.375rem; min-height: 38px; box-shadow: none;">
                                <span id="lob-selection-display" style="color: #6c757d; font-weight: 400;">Select LOBs...</span>
                                <i class="fas fa-chevron-down" style="color: #6c757d; font-size: 12px;"></i>
                            </button>
                            <ul class="dropdown-menu w-100 shadow-lg border-0" id="lob-dropdown-menu" style="max-height: 280px; overflow-y: auto; border-radius: 0.5rem; margin-top: 4px;">
                                <li class="px-3 py-2 border-bottom" style="background: #f8f9fa;">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text bg-white border-end-0" style="border-color: #e3e6f0;">
                                            <i class="fas fa-search text-muted" style="font-size: 12px;"></i>
                                        </span>
                                        <input type="text" class="form-control border-start-0" placeholder="Search LOBs..." id="lob-search" style="border-color: #e3e6f0; box-shadow: none;">
                                    </div>
                                </li>
                                <li class="lob-option" data-value="Customer Service">
                                    <div class="dropdown-item py-2 px-3" style="transition: all 0.2s ease;">
                                        <div class="form-check m-0">
                                            <input class="form-check-input lob-checkbox" type="checkbox" value="Customer Service" id="lob-1" style="margin-top: 2px;">
                                            <label class="form-check-label w-100 ps-2" for="lob-1" style="font-weight: 500; color: #495057; cursor: pointer;">
                                                <i class="fas fa-headset me-2 text-primary" style="font-size: 14px;"></i>Customer Service
                                            </label>
                                        </div>
                                    </div>
                                </li>
                                <li class="lob-option" data-value="Technical Support">
                                    <div class="dropdown-item py-2 px-3" style="transition: all 0.2s ease;">
                                        <div class="form-check m-0">
                                            <input class="form-check-input lob-checkbox" type="checkbox" value="Technical Support" id="lob-2" style="margin-top: 2px;">
                                            <label class="form-check-label w-100 ps-2" for="lob-2" style="font-weight: 500; color: #495057; cursor: pointer;">
                                                <i class="fas fa-tools me-2 text-success" style="font-size: 14px;"></i>Technical Support
                                            </label>
                                        </div>
                                    </div>
                                </li>
                                <li class="lob-option" data-value="Sales">
                                    <div class="dropdown-item py-2 px-3" style="transition: all 0.2s ease;">
                                        <div class="form-check m-0">
                                            <input class="form-check-input lob-checkbox" type="checkbox" value="Sales" id="lob-3" style="margin-top: 2px;">
                                            <label class="form-check-label w-100 ps-2" for="lob-3" style="font-weight: 500; color: #495057; cursor: pointer;">
                                                <i class="fas fa-chart-line me-2 text-info" style="font-size: 14px;"></i>Sales
                                            </label>
                                        </div>
                                    </div>
                                </li>
                                <li class="lob-option" data-value="Billing">
                                    <div class="dropdown-item py-2 px-3" style="transition: all 0.2s ease;">
                                        <div class="form-check m-0">
                                            <input class="form-check-input lob-checkbox" type="checkbox" value="Billing" id="lob-4" style="margin-top: 2px;">
                                            <label class="form-check-label w-100 ps-2" for="lob-4" style="font-weight: 500; color: #495057; cursor: pointer;">
                                                <i class="fas fa-file-invoice-dollar me-2 text-warning" style="font-size: 14px;"></i>Billing
                                            </label>
                                        </div>
                                    </div>
                                </li>
                                <li class="lob-option" data-value="Collections">
                                    <div class="dropdown-item py-2 px-3" style="transition: all 0.2s ease;">
                                        <div class="form-check m-0">
                                            <input class="form-check-input lob-checkbox" type="checkbox" value="Collections" id="lob-5" style="margin-top: 2px;">
                                            <label class="form-check-label w-100 ps-2" for="lob-5" style="font-weight: 500; color: #495057; cursor: pointer;">
                                                <i class="fas fa-hand-holding-usd me-2 text-danger" style="font-size: 14px;"></i>Collections
                                            </label>
                                        </div>
                                    </div>
                                </li>
                                <li class="lob-option" data-value="Back Office Operations">
                                    <div class="dropdown-item py-2 px-3" style="transition: all 0.2s ease;">
                                        <div class="form-check m-0">
                                            <input class="form-check-input lob-checkbox" type="checkbox" value="Back Office Operations" id="lob-6" style="margin-top: 2px;">
                                            <label class="form-check-label w-100 ps-2" for="lob-6" style="font-weight: 500; color: #495057; cursor: pointer;">
                                                <i class="fas fa-cogs me-2 text-secondary" style="font-size: 14px;"></i>Back Office Operations
                                            </label>
                                        </div>
                                    </div>
                                </li>
                                <li class="lob-option" data-value="Quality Assurance">
                                    <div class="dropdown-item py-2 px-3" style="transition: all 0.2s ease;">
                                        <div class="form-check m-0">
                                            <input class="form-check-input lob-checkbox" type="checkbox" value="Quality Assurance" id="lob-7" style="margin-top: 2px;">
                                            <label class="form-check-label w-100 ps-2" for="lob-7" style="font-weight: 500; color: #495057; cursor: pointer;">
                                                <i class="fas fa-clipboard-check me-2 text-primary" style="font-size: 14px;"></i>Quality Assurance
                                            </label>
                                        </div>
                                    </div>
                                </li>
                                <li class="lob-option" data-value="Retention">
                                    <div class="dropdown-item py-2 px-3" style="transition: all 0.2s ease;">
                                        <div class="form-check m-0">
                                            <input class="form-check-input lob-checkbox" type="checkbox" value="Retention" id="lob-8" style="margin-top: 2px;">
                                            <label class="form-check-label w-100 ps-2" for="lob-8" style="font-weight: 500; color: #495057; cursor: pointer;">
                                                <i class="fas fa-user-shield me-2 text-success" style="font-size: 14px;"></i>Retention
                                            </label>
                                        </div>
                                    </div>
                                </li>
                                <li class="lob-option" data-value="Fraud Prevention">
                                    <div class="dropdown-item py-2 px-3" style="transition: all 0.2s ease;">
                                        <div class="form-check m-0">
                                            <input class="form-check-input lob-checkbox" type="checkbox" value="Fraud Prevention" id="lob-9" style="margin-top: 2px;">
                                            <label class="form-check-label w-100 ps-2" for="lob-9" style="font-weight: 500; color: #495057; cursor: pointer;">
                                                <i class="fas fa-shield-alt me-2 text-danger" style="font-size: 14px;"></i>Fraud Prevention
                                            </label>
                                        </div>
                                    </div>
                                </li>
                                <li class="lob-option" data-value="Others">
                                    <div class="dropdown-item py-2 px-3" style="transition: all 0.2s ease;">
                                        <div class="form-check m-0">
                                            <input class="form-check-input lob-checkbox" type="checkbox" value="Others" id="lob-10" style="margin-top: 2px;">
                                            <label class="form-check-label w-100 ps-2" for="lob-10" style="font-weight: 500; color: #495057; cursor: pointer;">
                                                <i class="fas fa-ellipsis-h me-2 text-muted" style="font-size: 14px;"></i>Others
                                            </label>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                            <!-- Hidden select for form submission -->
                            {{ form.lob_names(class="d-none", multiple=true, id="lob-names-select") }}
                        </div>
                        <small class="form-text text-muted" id="lob-selection-info">Select up to <span id="max-lob-count">0</span> LOBs</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Language & Channel Support Card -->
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card shadow-sm">
            <div class="card-header bg-info text-white">
                <h6 class="card-title mb-0">
                    <i class="fas fa-language me-2"></i>Language & Channel Support
                </h6>
            </div>
            <div class="card-body">
                <!-- Language Support Section -->
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-globe me-1"></i>Languages Supported
                        </label>
                        {{ form.languages_supported(class="form-select") }}
                    </div>
                    <div class="col-md-6" id="specify-languages-container" style="display: none;">
                        <label class="form-label fw-semibold">Specify the Languages</label>
                        {{ form.specify_languages(class="form-control", placeholder="Enter languages (e.g., English, Spanish, French)") }}
                    </div>
                </div>
                
                <hr class="my-4">
                
                <!-- Channel Support Section -->
                <div class="channel-support">
                    <label class="form-label fw-semibold mb-3">
                        <i class="fas fa-headset me-1"></i>Channel Support
                    </label>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-phone me-2"></i>Voice Channels
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="form-check mb-2">
                                        {{ form.voice_inbound(class="form-check-input") }}
                                        <label class="form-check-label" for="{{ form.voice_inbound.id }}">
                                            <i class="fas fa-phone-incoming me-1"></i>Voice - Inbound
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        {{ form.voice_outbound(class="form-check-input") }}
                                        <label class="form-check-label" for="{{ form.voice_outbound.id }}">
                                            <i class="fas fa-phone-outgoing me-1"></i>Voice - Outbound
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-comments me-2"></i>Digital Channels
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="form-check mb-2">
                                        {{ form.chat(class="form-check-input") }}
                                        <label class="form-check-label" for="{{ form.chat.id }}">
                                            <i class="fas fa-comment me-1"></i>Chat
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        {{ form.email(class="form-check-input") }}
                                        <label class="form-check-label" for="{{ form.email.id }}">
                                            <i class="fas fa-envelope me-1"></i>Email
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        {{ form.social_sms(class="form-check-input") }}
                                        <label class="form-check-label" for="{{ form.social_sms.id }}">
                                            <i class="fas fa-sms me-1"></i>Social/SMS
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-briefcase me-2"></i>Back Office
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="form-check">
                                        {{ form.back_office(class="form-check-input") }}
                                        <label class="form-check-label" for="{{ form.back_office.id }}">
                                            <i class="fas fa-file-alt me-1"></i>Back Office
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-plus me-2"></i>Other Channels
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="form-check mb-2">
                                        {{ form.others(class="form-check-input", id="others-checkbox") }}
                                        <label class="form-check-label" for="{{ form.others.id }}">
                                            <i class="fas fa-ellipsis-h me-1"></i>Others
                                        </label>
                                    </div>
                                    <!-- Others text input - hidden by default -->
                                    <div id="others-text-container" style="display: none;">
                                        {{ form.others_text(class="form-control form-control-sm", placeholder="Please specify other channels...") }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Channel Selection Summary -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="alert alert-light" role="alert">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Selected Channels Summary:</strong>
                            <span id="channel-summary">No channels selected</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Show/hide language specification field
    const languagesSupported = document.getElementById('languages_supported');
    const specifyContainer = document.getElementById('specify-languages-container');
    
    function toggleLanguageSpecify() {
        if (languagesSupported.value === 'bilingual' || languagesSupported.value === 'multilingual') {
            specifyContainer.style.display = 'block';
        } else {
            specifyContainer.style.display = 'none';
        }
    }
    
    if (languagesSupported) {
        languagesSupported.addEventListener('change', toggleLanguageSpecify);
        toggleLanguageSpecify(); // Initial call
    }
    
    // Show/hide others text field
    const othersCheckbox = document.getElementById('others-checkbox');
    const othersContainer = document.getElementById('others-text-container');
    
    function toggleOthersText() {
        if (othersCheckbox.checked) {
            othersContainer.style.display = 'block';
        } else {
            othersContainer.style.display = 'none';
        }
    }
    
    if (othersCheckbox) {
        othersCheckbox.addEventListener('change', toggleOthersText);
        toggleOthersText(); // Initial call
    }
    
    // Update channel summary
    function updateChannelSummary() {
        const channels = [];
        const checkboxes = [
            { id: 'voice_inbound', label: 'Voice Inbound' },
            { id: 'voice_outbound', label: 'Voice Outbound' },
            { id: 'chat', label: 'Chat' },
            { id: 'email', label: 'Email' },
            { id: 'back_office', label: 'Back Office' },
            { id: 'social_sms', label: 'Social/SMS' }
        ];
        
        checkboxes.forEach(function(channel) {
            const checkbox = document.getElementById(channel.id);
            if (checkbox && checkbox.checked) {
                channels.push(channel.label);
            }
        });
        
        // Check others
        if (othersCheckbox && othersCheckbox.checked) {
            const othersText = document.getElementById('others_text');
            if (othersText && othersText.value.trim()) {
                channels.push('Others: ' + othersText.value.trim());
            } else {
                channels.push('Others');
            }
        }
        
        const summaryElement = document.getElementById('channel-summary');
        if (summaryElement) {
            if (channels.length > 0) {
                summaryElement.textContent = channels.join(', ');
            } else {
                summaryElement.textContent = 'No channels selected';
            }
        }
    }
    
    // Add event listeners to all channel checkboxes
    document.querySelectorAll('input[type="checkbox"]').forEach(function(checkbox) {
        checkbox.addEventListener('change', updateChannelSummary);
    });
    
    // Add event listener to others text field
    const othersText = document.getElementById('others_text');
    if (othersText) {
        othersText.addEventListener('input', updateChannelSummary);
    }
    
    // Initial summary update
    updateChannelSummary();
    
    // LOB filterable dropdown functionality
    const lobCountField = document.getElementById('lob_count');
    const lobNamesSelect = document.getElementById('lob-names-select');
    const lobDropdownToggle = document.getElementById('lob-dropdown-toggle');
    const lobSelectionDisplay = document.getElementById('lob-selection-display');
    const lobSearchInput = document.getElementById('lob-search');
    const lobCheckboxes = document.querySelectorAll('.lob-checkbox');
    const lobOptions = document.querySelectorAll('.lob-option');
    const maxLobCountSpan = document.getElementById('max-lob-count');
    const lobSelectionInfo = document.getElementById('lob-selection-info');
    
    console.log('LOB elements found:', {
        lobCountField: !!lobCountField,
        lobNamesSelect: !!lobNamesSelect,
        lobDropdownToggle: !!lobDropdownToggle,
        lobSelectionDisplay: !!lobSelectionDisplay,
        lobCheckboxes: lobCheckboxes.length
    });
    
    function updateLobLimit() {
        const maxCount = parseInt(lobCountField.value) || 0;
        maxLobCountSpan.textContent = maxCount;
        
        if (maxCount === 0) {
            lobSelectionInfo.style.display = 'none';
            // Disable dropdown if no count specified
            lobDropdownToggle.style.opacity = '0.5';
            lobDropdownToggle.style.pointerEvents = 'none';
            clearLobSelections();
        } else {
            lobSelectionInfo.style.display = 'block';
            lobDropdownToggle.style.opacity = '1';
            lobDropdownToggle.style.pointerEvents = 'auto';
        }
    }
    
    function clearLobSelections() {
        lobCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        updateLobDisplay();
        updateHiddenSelect();
    }
    
    function updateLobDisplay() {
        const selectedCheckboxes = Array.from(lobCheckboxes).filter(cb => cb.checked);
        
        if (selectedCheckboxes.length === 0) {
            lobSelectionDisplay.innerHTML = '<span style="color: #6c757d; font-weight: 400;">Select LOBs...</span>';
        } else if (selectedCheckboxes.length === 1) {
            const selectedText = selectedCheckboxes[0].nextElementSibling.textContent.trim().replace(/^\s*[\w-]+\s*/, ''); // Remove icon text
            lobSelectionDisplay.innerHTML = `<span style="color: #495057; font-weight: 500;">${selectedText}</span>`;
        } else {
            lobSelectionDisplay.innerHTML = `<span style="color: #495057; font-weight: 500;"><i class="fas fa-check-circle me-1 text-success"></i>${selectedCheckboxes.length} LOBs selected</span>`;
        }
    }
    
    function updateHiddenSelect() {
        // Update the hidden select element for form submission
        const selectedValues = Array.from(lobCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);
        
        Array.from(lobNamesSelect.options).forEach(option => {
            option.selected = selectedValues.includes(option.value);
        });
    }
    
    function validateLobSelection(clickedCheckbox) {
        const maxCount = parseInt(lobCountField.value) || 0;
        const selectedCheckboxes = Array.from(lobCheckboxes).filter(cb => cb.checked);
        
        if (selectedCheckboxes.length > maxCount && maxCount > 0) {
            // If user just checked a box and exceeded limit, uncheck it
            if (clickedCheckbox && clickedCheckbox.checked) {
                clickedCheckbox.checked = false;
                alert(`You can only select up to ${maxCount} LOBs.`);
            }
        }
        
        updateLobDisplay();
        updateHiddenSelect();
    }
    
    function filterLobOptions() {
        const searchTerm = lobSearchInput.value.toLowerCase();
        
        lobOptions.forEach(option => {
            const text = option.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
                option.style.display = 'block';
            } else {
                option.style.display = 'none';
            }
        });
    }
    
    // Event listeners for LOB functionality
    if (lobCountField) {
        lobCountField.addEventListener('input', updateLobLimit);
        lobCountField.addEventListener('change', updateLobLimit);
        updateLobLimit(); // Initial call
    }
    
    // Search functionality
    if (lobSearchInput) {
        lobSearchInput.addEventListener('input', filterLobOptions);
        // Prevent dropdown from closing when typing in search
        lobSearchInput.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    }
    
    // Checkbox change events
    lobCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            validateLobSelection(this);
        });
    });
    
    // Initialize display
    updateLobDisplay();
    
    // Add hover effects
    const style = document.createElement('style');
    style.textContent = `
        .dropdown-item:hover {
            background-color: #f8f9fa !important;
            transform: translateX(2px);
        }
        .lob-option .dropdown-item:hover {
            background: linear-gradient(90deg, #f8f9fa 0%, #e9ecef 100%) !important;
        }
        .lob-checkbox:checked + .form-check-label {
            color: #0d6efd !important;
            font-weight: 600 !important;
        }
        .lob-checkbox:checked + .form-check-label i {
            color: #0d6efd !important;
        }
        #lob-dropdown-toggle:focus {
            border-color: #86b7fe !important;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25) !important;
        }
    `;
    document.head.appendChild(style);
});
</script>
{% endblock %}