{% extends "base_step.html" %}

{% block title %}Program Details - WFM Analytics{% endblock %}

{% block form_content %}
<!-- Program Details Availability Section -->
<div class="row mb-4">
    <div class="col-lg-8 mx-auto">
        <div class="mb-4">
            <div class="form-label fw-bold text-success mb-3">
                <i class="fas fa-question-circle me-2"></i>Program Details Availability
            </div>
            <div class="card border-0 shadow-sm bg-light">
                <div class="card-body p-4">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label fw-bold text-dark mb-3">
                                Do you have Program Details?
                            </label>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-check form-check-inline p-3 border rounded bg-white shadow-sm">
                                        <input class="form-check-input" type="radio" name="program-availability" id="program-available" value="available" onchange="toggleProgramDetails()">
                                        <label class="form-check-label fw-bold text-success ms-2" for="program-available">
                                            <i class="fas fa-check-circle me-2"></i>Available
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-check-inline p-3 border rounded bg-white shadow-sm">
                                        <input class="form-check-input" type="radio" name="program-availability" id="program-unavailable" value="unavailable" onchange="toggleProgramDetails()">
                                        <label class="form-check-label fw-bold text-secondary ms-2" for="program-unavailable">
                                            <i class="fas fa-times-circle me-2"></i>Currently Unavailable
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Program Details Content (Initially Hidden) -->
<div id="program-details-content" style="display: none;">
<!-- LOB Details Card -->
<div class="row mb-4">
    <div class="col-lg-8 mx-auto">
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-building me-2"></i>LOB Details
                    </h6>
                    <button type="submit" class="btn btn-outline-light" style="padding: 0.25rem; width: 28px; height: 28px; border-radius: 0.375rem; display: inline-flex; align-items: center; justify-content: center;" title="Save">
                        <i class="fas fa-save" style="font-size: 0.8rem;"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-hashtag me-1"></i>LOB Count
                        </label>
                        {{ form.lob_count(class="form-control", placeholder="Enter number of LOBs") }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-list-ul me-1"></i>LOB Names
                        </label>
                        <div class="dropdown">
                            <button class="form-control dropdown-toggle d-flex justify-content-between align-items-center text-start" 
                                    type="button" 
                                    id="lob-dropdown-toggle" 
                                    data-bs-toggle="dropdown" 
                                    aria-expanded="false"
                                    style="background: #ffffff; border: 1px solid #ced4da; border-radius: 0.375rem; min-height: 38px; box-shadow: none;">
                                <span id="lob-selection-display" style="color: #6c757d; font-weight: 400;">Select LOBs...</span>
                                <i class="fas fa-chevron-down" style="color: #6c757d; font-size: 12px;"></i>
                            </button>
                            <ul class="dropdown-menu w-100 shadow-lg border-0" id="lob-dropdown-menu" style="max-height: 280px; overflow-y: auto; border-radius: 0.5rem; margin-top: 4px;">
                                <li class="px-3 py-2 border-bottom" style="background: #f8f9fa;">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text bg-white border-end-0" style="border-color: #e3e6f0;">
                                            <i class="fas fa-search text-muted" style="font-size: 12px;"></i>
                                        </span>
                                        <input type="text" class="form-control border-start-0" placeholder="Search LOBs..." id="lob-search" style="border-color: #e3e6f0; box-shadow: none;">
                                    </div>
                                </li>
                                <li class="lob-option" data-value="Customer Service">
                                    <div class="dropdown-item py-2 px-3" style="transition: all 0.2s ease;">
                                        <div class="form-check m-0">
                                            <input class="form-check-input lob-checkbox" type="checkbox" value="Customer Service" id="lob-1" style="margin-top: 2px;">
                                            <label class="form-check-label w-100 ps-2" for="lob-1" style="font-weight: 500; color: #495057; cursor: pointer;">
                                                <i class="fas fa-headset me-2 text-primary" style="font-size: 14px;"></i>Customer Service
                                            </label>
                                        </div>
                                    </div>
                                </li>
                                <li class="lob-option" data-value="Technical Support">
                                    <div class="dropdown-item py-2 px-3" style="transition: all 0.2s ease;">
                                        <div class="form-check m-0">
                                            <input class="form-check-input lob-checkbox" type="checkbox" value="Technical Support" id="lob-2" style="margin-top: 2px;">
                                            <label class="form-check-label w-100 ps-2" for="lob-2" style="font-weight: 500; color: #495057; cursor: pointer;">
                                                <i class="fas fa-tools me-2 text-success" style="font-size: 14px;"></i>Technical Support
                                            </label>
                                        </div>
                                    </div>
                                </li>
                                <li class="lob-option" data-value="Sales">
                                    <div class="dropdown-item py-2 px-3" style="transition: all 0.2s ease;">
                                        <div class="form-check m-0">
                                            <input class="form-check-input lob-checkbox" type="checkbox" value="Sales" id="lob-3" style="margin-top: 2px;">
                                            <label class="form-check-label w-100 ps-2" for="lob-3" style="font-weight: 500; color: #495057; cursor: pointer;">
                                                <i class="fas fa-chart-line me-2 text-info" style="font-size: 14px;"></i>Sales
                                            </label>
                                        </div>
                                    </div>
                                </li>
                                <li class="lob-option" data-value="Billing">
                                    <div class="dropdown-item py-2 px-3" style="transition: all 0.2s ease;">
                                        <div class="form-check m-0">
                                            <input class="form-check-input lob-checkbox" type="checkbox" value="Billing" id="lob-4" style="margin-top: 2px;">
                                            <label class="form-check-label w-100 ps-2" for="lob-4" style="font-weight: 500; color: #495057; cursor: pointer;">
                                                <i class="fas fa-file-invoice-dollar me-2 text-warning" style="font-size: 14px;"></i>Billing
                                            </label>
                                        </div>
                                    </div>
                                </li>
                                <li class="lob-option" data-value="Collections">
                                    <div class="dropdown-item py-2 px-3" style="transition: all 0.2s ease;">
                                        <div class="form-check m-0">
                                            <input class="form-check-input lob-checkbox" type="checkbox" value="Collections" id="lob-5" style="margin-top: 2px;">
                                            <label class="form-check-label w-100 ps-2" for="lob-5" style="font-weight: 500; color: #495057; cursor: pointer;">
                                                <i class="fas fa-hand-holding-usd me-2 text-danger" style="font-size: 14px;"></i>Collections
                                            </label>
                                        </div>
                                    </div>
                                </li>
                                <li class="lob-option" data-value="Back Office Operations">
                                    <div class="dropdown-item py-2 px-3" style="transition: all 0.2s ease;">
                                        <div class="form-check m-0">
                                            <input class="form-check-input lob-checkbox" type="checkbox" value="Back Office Operations" id="lob-6" style="margin-top: 2px;">
                                            <label class="form-check-label w-100 ps-2" for="lob-6" style="font-weight: 500; color: #495057; cursor: pointer;">
                                                <i class="fas fa-cogs me-2 text-secondary" style="font-size: 14px;"></i>Back Office Operations
                                            </label>
                                        </div>
                                    </div>
                                </li>
                                <li class="lob-option" data-value="Quality Assurance">
                                    <div class="dropdown-item py-2 px-3" style="transition: all 0.2s ease;">
                                        <div class="form-check m-0">
                                            <input class="form-check-input lob-checkbox" type="checkbox" value="Quality Assurance" id="lob-7" style="margin-top: 2px;">
                                            <label class="form-check-label w-100 ps-2" for="lob-7" style="font-weight: 500; color: #495057; cursor: pointer;">
                                                <i class="fas fa-clipboard-check me-2 text-primary" style="font-size: 14px;"></i>Quality Assurance
                                            </label>
                                        </div>
                                    </div>
                                </li>
                                <li class="lob-option" data-value="Retention">
                                    <div class="dropdown-item py-2 px-3" style="transition: all 0.2s ease;">
                                        <div class="form-check m-0">
                                            <input class="form-check-input lob-checkbox" type="checkbox" value="Retention" id="lob-8" style="margin-top: 2px;">
                                            <label class="form-check-label w-100 ps-2" for="lob-8" style="font-weight: 500; color: #495057; cursor: pointer;">
                                                <i class="fas fa-user-shield me-2 text-success" style="font-size: 14px;"></i>Retention
                                            </label>
                                        </div>
                                    </div>
                                </li>
                                <li class="lob-option" data-value="Fraud Prevention">
                                    <div class="dropdown-item py-2 px-3" style="transition: all 0.2s ease;">
                                        <div class="form-check m-0">
                                            <input class="form-check-input lob-checkbox" type="checkbox" value="Fraud Prevention" id="lob-9" style="margin-top: 2px;">
                                            <label class="form-check-label w-100 ps-2" for="lob-9" style="font-weight: 500; color: #495057; cursor: pointer;">
                                                <i class="fas fa-shield-alt me-2 text-danger" style="font-size: 14px;"></i>Fraud Prevention
                                            </label>
                                        </div>
                                    </div>
                                </li>
                                <li class="lob-option" data-value="Others">
                                    <div class="dropdown-item py-2 px-3" style="transition: all 0.2s ease;">
                                        <div class="form-check m-0">
                                            <input class="form-check-input lob-checkbox" type="checkbox" value="Others" id="lob-10" style="margin-top: 2px;">
                                            <label class="form-check-label w-100 ps-2" for="lob-10" style="font-weight: 500; color: #495057; cursor: pointer;">
                                                <i class="fas fa-ellipsis-h me-2 text-muted" style="font-size: 14px;"></i>Others
                                            </label>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                            <!-- Hidden select for form submission -->
                            {{ form.lob_names(class="d-none", multiple=true, id="lob-names-select") }}
                        </div>
                        <small class="form-text text-muted" id="lob-selection-info">Select up to <span id="max-lob-count">0</span> LOBs</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Dynamic Language & Channel Support Sections -->
<div id="lob-language-channel-sections" class="mt-4">
    <!-- This will be populated dynamically based on selected LOBs -->
</div>

<!-- No LOBs Selected Message -->
<div id="no-lob-selected-message" class="row mt-4" style="display: none;">
    <div class="col-lg-8 mx-auto">
        <div class="alert alert-info text-center border-0 shadow-sm" style="background: linear-gradient(135deg, #e3f2fd 0%, #f3f4f6 100%);">
            <i class="fas fa-info-circle me-2 text-primary"></i>
            <strong>Select LOBs above to configure Language & Channel Support for each LOB</strong>
        </div>
    </div>
</div>
</div> <!-- End of program-details-content -->

{% endblock %}

{% block extra_js %}
<script>
// Toggle Program Details based on availability selection
function toggleProgramDetails() {
    const selectedRadio = document.querySelector('input[name="program-availability"]:checked');
    const availability = selectedRadio ? selectedRadio.value : '';
    const content = document.getElementById('program-details-content');
    
    if (availability === 'available') {
        content.style.display = 'block';
    } else {
        content.style.display = 'none';
        // Clear all form data when hiding
        clearProgramFormData();
    }
}

// Clear all program form data
function clearProgramFormData() {
    // Clear LOB count
    const lobCountField = document.getElementById('lob_count');
    if (lobCountField) lobCountField.value = '';
    
    // Clear LOB checkboxes
    document.querySelectorAll('.lob-checkbox').forEach(function(checkbox) {
        checkbox.checked = false;
    });
    
    // Update LOB selection display
    const lobSelectionDisplay = document.getElementById('lob-selection-display');
    if (lobSelectionDisplay) {
        lobSelectionDisplay.textContent = 'Select LOBs...';
        lobSelectionDisplay.style.color = '#6c757d';
    }
    
    // Clear language support
    const languagesSupported = document.getElementById('languages_supported');
    if (languagesSupported) languagesSupported.value = '';
    
    // Clear specify languages
    const specifyLanguages = document.getElementById('specify_languages');
    if (specifyLanguages) specifyLanguages.value = '';
    
    // Hide specify languages container
    const specifyContainer = document.getElementById('specify-languages-container');
    if (specifyContainer) specifyContainer.style.display = 'none';
    
    // Clear dynamic LOB sections
    const lobSections = document.getElementById('lob-language-channel-sections');
    if (lobSections) lobSections.innerHTML = '';
    
    // Hide no LOBs message
    const noLobMessage = document.getElementById('no-lob-selected-message');
    if (noLobMessage) noLobMessage.style.display = 'none';
}

// Generate dynamic Language & Channel Support sections for selected LOBs
function generateLobSections() {
    const selectedLobs = Array.from(document.querySelectorAll('.lob-checkbox:checked')).map(cb => cb.value);
    const lobSectionsContainer = document.getElementById('lob-language-channel-sections');
    const noLobMessage = document.getElementById('no-lob-selected-message');
    
    // Clear existing sections
    lobSectionsContainer.innerHTML = '';
    
    if (selectedLobs.length === 0) {
        noLobMessage.style.display = 'block';
        return;
    }
    
    noLobMessage.style.display = 'none';
    
    selectedLobs.forEach((lob, index) => {
        const section = createLobSection(lob, index);
        lobSectionsContainer.appendChild(section);
    });
    
    // Add event listeners to newly created elements
    addDynamicEventListeners();
}

// Create a Language & Channel Support section for a specific LOB
function createLobSection(lobName, index) {
    const lobId = lobName.toLowerCase().replace(/[^a-z0-9]/g, '_');
    const colors = ['primary', 'success', 'info', 'warning', 'secondary'];
    const color = colors[index % colors.length];
    
    const section = document.createElement('div');
    section.className = 'row mb-4';
    section.innerHTML = `
        <div class="col-lg-10 mx-auto">
            <div class="card shadow-lg border-0 lob-section" style="transition: all 0.3s ease;">
                <div class="card-header bg-${color} text-white position-relative overflow-hidden">
                    <div class="card-header-bg-effect"></div>
                    <div class="d-flex justify-content-between align-items-center position-relative">
                        <h6 class="card-title mb-0 fw-bold">
                            <i class="fas fa-building me-2"></i>${lobName}
                            <small class="badge bg-light text-${color} ms-2 fw-normal">Language & Channel Support</small>
                        </h6>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-white text-${color} me-2 fw-semibold">
                                <i class="fas fa-check-circle me-1"></i>LOB ${index + 1}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="card-body p-4">
                    <!-- Language Support Section -->
                    <div class="mb-4">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold text-dark mb-2">
                                    <i class="fas fa-globe me-2 text-${color}"></i>Languages Supported
                                </label>
                                <select class="form-select form-select-lg shadow-sm" id="languages_${lobId}" name="languages_${lobId}">
                                    <option value="">Select Language Support</option>
                                    <option value="english_only">English Only</option>
                                    <option value="bilingual">Bilingual</option>
                                    <option value="multilingual">Multilingual</option>
                                </select>
                            </div>
                            <div class="col-md-6" id="specify-languages-container-${lobId}" style="display: none;">
                                <label class="form-label fw-bold text-dark mb-2">Specify the Languages</label>
                                <input type="text" class="form-control form-control-lg shadow-sm" id="specify_languages_${lobId}" name="specify_languages_${lobId}" placeholder="e.g., English, Spanish, French">
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4 border-2">
                    
                    <!-- Channel Support Section -->
                    <div class="channel-support">
                        <div class="d-flex align-items-center mb-4">
                            <h6 class="fw-bold text-dark mb-0 me-3">
                                <i class="fas fa-headset me-2 text-${color}"></i>Channel Support
                            </h6>
                            <div class="flex-grow-1">
                                <div class="progress" style="height: 4px; border-radius: 10px;">
                                    <div class="progress-bar bg-${color}" style="width: 0%;" id="channel-progress-${lobId}"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row g-4">
                            <!-- Voice Channels -->
                            <div class="col-md-6">
                                <div class="card h-100 border-0 shadow-sm" style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);">
                                    <div class="card-header bg-light border-0 py-3">
                                        <h6 class="card-title mb-0 fw-bold text-dark">
                                            <i class="fas fa-phone me-2 text-primary"></i>Voice Channels
                                        </h6>
                                    </div>
                                    <div class="card-body py-3">
                                        <div class="form-check mb-3 p-2 rounded" style="background: rgba(13, 110, 253, 0.1);">
                                            <input class="form-check-input channel-checkbox" type="checkbox" id="voice_inbound_${lobId}" name="voice_inbound_${lobId}" data-lob="${lobId}">
                                            <label class="form-check-label fw-semibold" for="voice_inbound_${lobId}">
                                                <i class="fas fa-phone-volume me-2 text-success"></i>Voice - Inbound
                                            </label>
                                        </div>
                                        <div class="form-check p-2 rounded" style="background: rgba(25, 135, 84, 0.1);">
                                            <input class="form-check-input channel-checkbox" type="checkbox" id="voice_outbound_${lobId}" name="voice_outbound_${lobId}" data-lob="${lobId}">
                                            <label class="form-check-label fw-semibold" for="voice_outbound_${lobId}">
                                                <i class="fas fa-phone-alt me-2 text-primary"></i>Voice - Outbound
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Digital Channels -->
                            <div class="col-md-6">
                                <div class="card h-100 border-0 shadow-sm" style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);">
                                    <div class="card-header bg-light border-0 py-3">
                                        <h6 class="card-title mb-0 fw-bold text-dark">
                                            <i class="fas fa-comments me-2 text-info"></i>Digital Channels
                                        </h6>
                                    </div>
                                    <div class="card-body py-3">
                                        <div class="form-check mb-2 p-2 rounded" style="background: rgba(13, 202, 240, 0.1);">
                                            <input class="form-check-input channel-checkbox" type="checkbox" id="chat_${lobId}" name="chat_${lobId}" data-lob="${lobId}">
                                            <label class="form-check-label fw-semibold" for="chat_${lobId}">
                                                <i class="fas fa-comment-dots me-2 text-info"></i>Chat
                                            </label>
                                        </div>
                                        <div class="form-check mb-2 p-2 rounded" style="background: rgba(220, 53, 69, 0.1);">
                                            <input class="form-check-input channel-checkbox" type="checkbox" id="email_${lobId}" name="email_${lobId}" data-lob="${lobId}">
                                            <label class="form-check-label fw-semibold" for="email_${lobId}">
                                                <i class="fas fa-envelope me-2 text-danger"></i>Email
                                            </label>
                                        </div>
                                        <div class="form-check p-2 rounded" style="background: rgba(255, 193, 7, 0.1);">
                                            <input class="form-check-input channel-checkbox" type="checkbox" id="social_sms_${lobId}" name="social_sms_${lobId}" data-lob="${lobId}">
                                            <label class="form-check-label fw-semibold" for="social_sms_${lobId}">
                                                <i class="fas fa-sms me-2 text-warning"></i>Social/SMS
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Back Office & Others -->
                            <div class="col-md-6">
                                <div class="card h-100 border-0 shadow-sm" style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);">
                                    <div class="card-header bg-light border-0 py-3">
                                        <h6 class="card-title mb-0 fw-bold text-dark">
                                            <i class="fas fa-briefcase me-2 text-secondary"></i>Back Office
                                        </h6>
                                    </div>
                                    <div class="card-body py-3">
                                        <div class="form-check p-2 rounded" style="background: rgba(108, 117, 125, 0.1);">
                                            <input class="form-check-input channel-checkbox" type="checkbox" id="back_office_${lobId}" name="back_office_${lobId}" data-lob="${lobId}">
                                            <label class="form-check-label fw-semibold" for="back_office_${lobId}">
                                                <i class="fas fa-file-alt me-2 text-secondary"></i>Back Office
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Others -->
                            <div class="col-md-6">
                                <div class="card h-100 border-0 shadow-sm" style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);">
                                    <div class="card-header bg-light border-0 py-3">
                                        <h6 class="card-title mb-0 fw-bold text-dark">
                                            <i class="fas fa-plus me-2 text-success"></i>Other Channels
                                        </h6>
                                    </div>
                                    <div class="card-body py-3">
                                        <div class="form-check mb-3 p-2 rounded" style="background: rgba(25, 135, 84, 0.1);">
                                            <input class="form-check-input channel-checkbox others-checkbox" type="checkbox" id="others_${lobId}" name="others_${lobId}" data-lob="${lobId}">
                                            <label class="form-check-label fw-semibold" for="others_${lobId}">
                                                <i class="fas fa-ellipsis-h me-2 text-success"></i>Others
                                            </label>
                                        </div>
                                        <div id="others-text-container-${lobId}" style="display: none;">
                                            <input type="text" class="form-control shadow-sm" id="others_text_${lobId}" name="others_text_${lobId}" placeholder="Please specify other channels...">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Channel Summary -->
                        <div class="mt-4">
                            <div class="alert border-0 shadow-sm" style="background: linear-gradient(135deg, #e3f2fd 0%, #f3f4f6 100%);">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-chart-bar me-3 text-${color}" style="font-size: 1.2rem;"></i>
                                    <div>
                                        <strong class="text-dark">Selected Channels:</strong>
                                        <span id="channel-summary-${lobId}" class="ms-2 text-muted">No channels selected</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    return section;
}

// Add event listeners to dynamically created elements
function addDynamicEventListeners() {
    // Language support event listeners
    document.querySelectorAll('[id^="languages_"]').forEach(select => {
        select.addEventListener('change', function() {
            const lobId = this.id.replace('languages_', '');
            const specifyContainer = document.getElementById(`specify-languages-container-${lobId}`);
            
            if (this.value === 'bilingual' || this.value === 'multilingual') {
                specifyContainer.style.display = 'block';
            } else {
                specifyContainer.style.display = 'none';
                const specifyInput = document.getElementById(`specify_languages_${lobId}`);
                if (specifyInput) specifyInput.value = '';
            }
        });
    });
    
    // Channel checkbox event listeners
    document.querySelectorAll('.channel-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const lobId = this.dataset.lob;
            updateChannelSummary(lobId);
            updateChannelProgress(lobId);
            
            // Handle others checkbox
            if (this.id.includes('others_')) {
                const othersContainer = document.getElementById(`others-text-container-${lobId}`);
                if (this.checked) {
                    othersContainer.style.display = 'block';
                } else {
                    othersContainer.style.display = 'none';
                    const othersText = document.getElementById(`others_text_${lobId}`);
                    if (othersText) othersText.value = '';
                }
            }
        });
    });
    
    // Others text input listeners
    document.querySelectorAll('[id^="others_text_"]').forEach(input => {
        input.addEventListener('input', function() {
            const lobId = this.id.replace('others_text_', '');
            updateChannelSummary(lobId);
        });
    });
}

// Update channel summary for specific LOB
function updateChannelSummary(lobId) {
    const channels = [];
    const checkboxes = [
        { id: `voice_inbound_${lobId}`, label: 'Voice Inbound' },
        { id: `voice_outbound_${lobId}`, label: 'Voice Outbound' },
        { id: `chat_${lobId}`, label: 'Chat' },
        { id: `email_${lobId}`, label: 'Email' },
        { id: `social_sms_${lobId}`, label: 'Social/SMS' },
        { id: `back_office_${lobId}`, label: 'Back Office' }
    ];
    
    checkboxes.forEach(channel => {
        const checkbox = document.getElementById(channel.id);
        if (checkbox && checkbox.checked) {
            channels.push(channel.label);
        }
    });
    
    // Check others
    const othersCheckbox = document.getElementById(`others_${lobId}`);
    if (othersCheckbox && othersCheckbox.checked) {
        const othersText = document.getElementById(`others_text_${lobId}`);
        if (othersText && othersText.value.trim()) {
            channels.push(`Others: ${othersText.value.trim()}`);
        } else {
            channels.push('Others');
        }
    }
    
    const summaryElement = document.getElementById(`channel-summary-${lobId}`);
    if (summaryElement) {
        if (channels.length > 0) {
            summaryElement.textContent = channels.join(', ');
            summaryElement.className = 'ms-2 text-success fw-semibold';
        } else {
            summaryElement.textContent = 'No channels selected';
            summaryElement.className = 'ms-2 text-muted';
        }
    }
}

// Update channel progress bar for specific LOB
function updateChannelProgress(lobId) {
    const totalChannels = 6; // Total possible channels
    const selectedChannels = document.querySelectorAll(`[data-lob="${lobId}"]:checked`).length;
    const percentage = (selectedChannels / totalChannels) * 100;
    
    const progressBar = document.getElementById(`channel-progress-${lobId}`);
    if (progressBar) {
        progressBar.style.width = `${percentage}%`;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    
    // LOB filterable dropdown functionality
    const lobCountField = document.getElementById('lob_count');
    const lobNamesSelect = document.getElementById('lob-names-select');
    const lobDropdownToggle = document.getElementById('lob-dropdown-toggle');
    const lobSelectionDisplay = document.getElementById('lob-selection-display');
    const lobSearchInput = document.getElementById('lob-search');
    const lobCheckboxes = document.querySelectorAll('.lob-checkbox');
    const lobOptions = document.querySelectorAll('.lob-option');
    const maxLobCountSpan = document.getElementById('max-lob-count');
    const lobSelectionInfo = document.getElementById('lob-selection-info');
    
    console.log('LOB elements found:', {
        lobCountField: !!lobCountField,
        lobNamesSelect: !!lobNamesSelect,
        lobDropdownToggle: !!lobDropdownToggle,
        lobSelectionDisplay: !!lobSelectionDisplay,
        lobCheckboxes: lobCheckboxes.length
    });
    
    function updateLobLimit() {
        const maxCount = parseInt(lobCountField.value) || 0;
        maxLobCountSpan.textContent = maxCount;
        
        if (maxCount === 0) {
            lobSelectionInfo.style.display = 'none';
            // Disable dropdown if no count specified
            lobDropdownToggle.style.opacity = '0.5';
            lobDropdownToggle.style.pointerEvents = 'none';
            clearLobSelections();
        } else {
            lobSelectionInfo.style.display = 'block';
            lobDropdownToggle.style.opacity = '1';
            lobDropdownToggle.style.pointerEvents = 'auto';
        }
    }
    
    function clearLobSelections() {
        lobCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        updateLobDisplay();
        updateHiddenSelect();
    }
    
    function updateLobDisplay() {
        const selectedCheckboxes = Array.from(lobCheckboxes).filter(cb => cb.checked);
        
        if (selectedCheckboxes.length === 0) {
            lobSelectionDisplay.innerHTML = '<span style="color: #6c757d; font-weight: 400;">Select LOBs...</span>';
        } else if (selectedCheckboxes.length === 1) {
            const selectedText = selectedCheckboxes[0].nextElementSibling.textContent.trim().replace(/^\s*[\w-]+\s*/, ''); // Remove icon text
            lobSelectionDisplay.innerHTML = `<span style="color: #495057; font-weight: 500;">${selectedText}</span>`;
        } else {
            lobSelectionDisplay.innerHTML = `<span style="color: #495057; font-weight: 500;"><i class="fas fa-check-circle me-1 text-success"></i>${selectedCheckboxes.length} LOBs selected</span>`;
        }
    }
    
    function updateHiddenSelect() {
        // Update the hidden select element for form submission
        const selectedValues = Array.from(lobCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);
        
        Array.from(lobNamesSelect.options).forEach(option => {
            option.selected = selectedValues.includes(option.value);
        });
    }
    
    function validateLobSelection(clickedCheckbox) {
        const maxCount = parseInt(lobCountField.value) || 0;
        const selectedCheckboxes = Array.from(lobCheckboxes).filter(cb => cb.checked);
        
        if (selectedCheckboxes.length > maxCount && maxCount > 0) {
            // If user just checked a box and exceeded limit, uncheck it
            if (clickedCheckbox && clickedCheckbox.checked) {
                clickedCheckbox.checked = false;
                alert(`You can only select up to ${maxCount} LOBs.`);
            }
        }
        
        updateLobDisplay();
        updateHiddenSelect();
        // Generate dynamic sections when LOB selection changes
        generateLobSections();
    }
    
    function filterLobOptions() {
        const searchTerm = lobSearchInput.value.toLowerCase();
        
        lobOptions.forEach(option => {
            const text = option.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
                option.style.display = 'block';
            } else {
                option.style.display = 'none';
            }
        });
    }
    
    // Event listeners for LOB functionality
    if (lobCountField) {
        lobCountField.addEventListener('input', updateLobLimit);
        lobCountField.addEventListener('change', updateLobLimit);
        updateLobLimit(); // Initial call
    }
    
    // Search functionality
    if (lobSearchInput) {
        lobSearchInput.addEventListener('input', filterLobOptions);
        // Prevent dropdown from closing when typing in search
        lobSearchInput.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    }
    
    // Checkbox change events
    lobCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            validateLobSelection(this);
        });
    });
    
    // Initialize display
    updateLobDisplay();
    
    // Add hover effects and corporate styling
    const style = document.createElement('style');
    style.textContent = `
        .dropdown-item:hover {
            background-color: #f8f9fa !important;
            transform: translateX(2px);
        }
        .lob-option .dropdown-item:hover {
            background: linear-gradient(90deg, #f8f9fa 0%, #e9ecef 100%) !important;
        }
        .lob-checkbox:checked + .form-check-label {
            color: #0d6efd !important;
            font-weight: 600 !important;
        }
        .lob-checkbox:checked + .form-check-label i {
            color: #0d6efd !important;
        }
        #lob-dropdown-toggle:focus {
            border-color: #86b7fe !important;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25) !important;
        }
        
        /* Corporate LOB Section Styling */
        .lob-section {
            border-left: 5px solid transparent;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .lob-section:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1) !important;
            border-left-color: var(--bs-primary);
        }
        
        .card-header-bg-effect {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            pointer-events: none;
        }
        
        .form-check:hover {
            transform: scale(1.02);
            transition: transform 0.2s ease;
        }
        
        .channel-checkbox:checked + .form-check-label {
            color: #198754 !important;
            font-weight: 600 !important;
        }
        
        .channel-checkbox:checked + .form-check-label i {
            animation: checkPulse 0.6s ease-in-out;
        }
        
        @keyframes checkPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .card .card-header {
            position: relative;
            overflow: hidden;
        }
        
        .badge {
            animation: fadeInUp 0.5s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .form-select:focus, .form-control:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
            transform: scale(1.02);
            transition: all 0.3s ease;
        }
        
        .progress {
            background: rgba(108, 117, 125, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .alert {
            border: none;
            backdrop-filter: blur(10px);
            animation: slideInUp 0.5s ease-out;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    `;
    document.head.appendChild(style);
    
    // Initialize with any pre-existing LOB selections
    generateLobSections();
});
</script>
{% endblock %}