{% extends "base_step.html" %}

{% block title %}Training Support - WFM Analytics{% endblock %}

{% block form_content %}
<!-- Training Schedule Card -->
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>Training Support
                    </h6>
                    <button type="submit" class="btn btn-success btn-sm">
                        <i class="fas fa-save me-2"></i>Save
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Training Support Type -->
                <div class="row g-3 mb-4">
                    <div class="col-12">
                        <label class="form-label fw-semibold required">Training Support Type</label>
                        <div class="d-flex gap-4 mt-2">
                            {% for value, label in form.training_support_type.choices %}
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" 
                                           name="{{ form.training_support_type.name }}" 
                                           id="{{ form.training_support_type.name }}_{{ value }}" 
                                           value="{{ value }}" 
                                           {% if form.training_support_type.data == value %}checked{% endif %}>
                                    <label class="form-check-label" for="{{ form.training_support_type.name }}_{{ value }}">
                                        {{ label }}
                                    </label>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- Internal Trainer Availability (conditional) -->
                <div id="internal-availability-section" class="row g-3 mb-4" style="display: none;">
                    <div class="col-12">
                        <label class="form-label fw-semibold required">Internal Trainer Available?</label>
                        <div class="d-flex gap-4 mt-2">
                            {% for value, label in form.internal_trainer_available.choices %}
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" 
                                           name="{{ form.internal_trainer_available.name }}" 
                                           id="{{ form.internal_trainer_available.name }}_{{ value }}" 
                                           value="{{ value }}" 
                                           {% if form.internal_trainer_available.data == value %}checked{% endif %}>
                                    <label class="form-check-label" for="{{ form.internal_trainer_available.name }}_{{ value }}">
                                        {{ label }}
                                    </label>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- Client Trainer Details (for Client selection) -->
                <div id="client-trainer-details" class="row g-3 mb-4" style="display: none;">
                    <div class="col-12">
                        <div class="alert alert-success">
                            <h6><i class="fas fa-user-tie me-2"></i>Client Trainer Details</h6>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold required">Client Trainer</label>
                        {{ form.client_trainer(class="form-select") }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold required"># of Total Trainer</label>
                        {{ form.total_trainers(class="form-control", readonly=true, style="background-color: #f8f9fa; color: #495057;", value="0") }}
                    </div>
                </div>

                <!-- Both Trainer Details (for Both selection) -->
                <div id="both-trainer-details" class="row g-3 mb-4" style="display: none;">
                    <div class="col-12">
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-users me-2"></i>Client & Internal Trainer Details</h6>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold required">Client Trainer</label>
                        {{ form.client_trainer(class="form-select") }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold required">Internal Trainer</label>
                        {{ form.internal_trainer(class="form-select") }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold required"># of Total Trainer</label>
                        {{ form.total_trainers(class="form-control", readonly=true, style="background-color: #f8f9fa; color: #495057;", value="0") }}
                    </div>
                </div>

                <!-- Internal Trainer Details (for Internal selection after Yes) -->
                <div id="internal-trainer-details" class="row g-3 mb-4" style="display: none;">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-user-tie me-2"></i>Internal Trainer Details</h6>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold required">Internal Trainer</label>
                        {{ form.internal_trainer(class="form-select") }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold required"># of Total Trainer</label>
                        {{ form.total_trainers(class="form-control", readonly=true, style="background-color: #f8f9fa; color: #495057;", value="0") }}
                    </div>
                </div>

                <!-- Additional Fields (shown conditionally) -->
                <div id="additional-fields" class="additional-fields" style="display: none;">
                    <hr class="my-4">
                    <h6 class="text-muted mb-3">
                        <i class="fas fa-info-circle me-2"></i>Additional Training Details
                    </h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Training Duration</label>
                            <div class="d-flex gap-2 align-items-center">
                                <div class="flex-shrink-0" style="min-width: 100px;">
                                    {{ form.training_duration(class="form-select") }}
                                </div>
                                <div id="training-duration-number-container" style="display: none; min-width: 80px;">
                                    {{ form.training_duration_number(class="form-select") }}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Nesting Duration</label>
                            <div class="d-flex gap-2 align-items-center">
                                <div class="flex-shrink-0" style="min-width: 100px;">
                                    {{ form.nesting_duration(class="form-select") }}
                                </div>
                                <div id="nesting-duration-number-container" style="display: none; min-width: 80px;">
                                    {{ form.nesting_duration_number(class="form-select") }}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Batch Size</label>
                            {{ form.batch_size(class="form-select") }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Training support type logic
    const trainingSupportRadios = document.querySelectorAll('input[name="training_support_type"]');
    const internalAvailabilitySection = document.getElementById('internal-availability-section');
    const internalTrainerAvailableRadios = document.querySelectorAll('input[name="internal_trainer_available"]');
    const clientTrainerDetails = document.getElementById('client-trainer-details');
    const bothTrainerDetails = document.getElementById('both-trainer-details');
    const internalTrainerDetails = document.getElementById('internal-trainer-details');
    
    // Handle training support type change
    trainingSupportRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            // Hide all sections first
            internalAvailabilitySection.style.display = 'none';
            clientTrainerDetails.style.display = 'none';
            bothTrainerDetails.style.display = 'none';
            internalTrainerDetails.style.display = 'none';
            hideAdditionalFields();
            
            // Reset internal availability selection
            internalTrainerAvailableRadios.forEach(r => r.checked = false);
            
            // Show appropriate section based on selection
            if (this.value === 'client') {
                clientTrainerDetails.style.display = 'block';
                showAdditionalFields();
            } else if (this.value === 'both') {
                bothTrainerDetails.style.display = 'block';
                showAdditionalFields();
            } else if (this.value === 'internal') {
                internalAvailabilitySection.style.display = 'block';
            }
            
            // Recalculate totals after changing sections
            calculateTotalTrainers();
        });
    });
    
    // Handle internal trainer availability change
    internalTrainerAvailableRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'yes') {
                internalTrainerDetails.style.display = 'block';
                showAdditionalFields();
            } else if (this.value === 'no') {
                internalTrainerDetails.style.display = 'none';
                hideAdditionalFields();
            }
            
            // Recalculate totals after changing availability
            calculateTotalTrainers();
        });
    });
    
    // Show/hide additional fields functions
    function showAdditionalFields() {
        document.getElementById('additional-fields').style.display = 'block';
    }
    
    function hideAdditionalFields() {
        document.getElementById('additional-fields').style.display = 'none';
    }
    
    // Initialize visibility based on current selection
    const selectedTrainingSupport = document.querySelector('input[name="training_support_type"]:checked');
    if (selectedTrainingSupport) {
        if (selectedTrainingSupport.value === 'client') {
            clientTrainerDetails.style.display = 'block';
            showAdditionalFields();
        } else if (selectedTrainingSupport.value === 'both') {
            bothTrainerDetails.style.display = 'block';
            showAdditionalFields();
        } else if (selectedTrainingSupport.value === 'internal') {
            internalAvailabilitySection.style.display = 'block';
            
            const selectedAvailability = document.querySelector('input[name="internal_trainer_available"]:checked');
            if (selectedAvailability && selectedAvailability.value === 'yes') {
                internalTrainerDetails.style.display = 'block';
                showAdditionalFields();
            }
        }
        
        // Calculate initial totals
        calculateTotalTrainers();
    }
    
    // Calculate total trainers based on current section
    function calculateTotalTrainers() {
        let total = 0;
        
        // Get current training support selection
        const selectedTrainingSupport = document.querySelector('input[name="training_support_type"]:checked');
        
        if (selectedTrainingSupport) {
            if (selectedTrainingSupport.value === 'client') {
                // Client section: only client trainer
                const clientField = document.querySelector('#client-trainer-details select[name="client_trainer"]');
                total = parseInt(clientField?.value) || 0;
            } else if (selectedTrainingSupport.value === 'both') {
                // Both section: client + internal
                const clientField = document.querySelector('#both-trainer-details select[name="client_trainer"]');
                const internalField = document.querySelector('#both-trainer-details select[name="internal_trainer"]');
                const client = parseInt(clientField?.value) || 0;
                const internal = parseInt(internalField?.value) || 0;
                total = client + internal;
            } else if (selectedTrainingSupport.value === 'internal') {
                // Internal section: only internal trainer (if trainer is available)
                const selectedAvailability = document.querySelector('input[name="internal_trainer_available"]:checked');
                if (selectedAvailability && selectedAvailability.value === 'yes') {
                    const internalField = document.querySelector('#internal-trainer-details select[name="internal_trainer"]');
                    total = parseInt(internalField?.value) || 0;
                }
            }
        }
        
        // Update all total trainer fields
        const totalFields = document.querySelectorAll('input[name="total_trainers"]');
        totalFields.forEach(field => {
            field.value = total;
        });
        
        // Show additional fields for all cases except Internal + No
        if (total > 0) {
            showAdditionalFields();
        }
    }
    
    // Bind change listeners to all trainer selects
    document.querySelectorAll('select[name="client_trainer"]').forEach(el => {
        el.addEventListener('change', calculateTotalTrainers);
    });
    document.querySelectorAll('select[name="internal_trainer"]').forEach(el => {
        el.addEventListener('change', calculateTotalTrainers);
    });
    
    // Show/hide duration number containers
    function setupDurationHandlers(durationId, containerId) {
        const duration = document.getElementById(durationId);
        const container = document.getElementById(containerId);
        
        if (duration && container) {
            function toggleDurationNumber() {
                if (duration.value && duration.value !== '') {
                    container.style.display = 'block';
                } else {
                    container.style.display = 'none';
                }
            }
            
            duration.addEventListener('change', toggleDurationNumber);
            toggleDurationNumber(); // Initial call
        }
    }
    
    setupDurationHandlers('training_duration', 'training-duration-number-container');
    setupDurationHandlers('nesting_duration', 'nesting-duration-number-container');
    
    // Initial setup - don't calculate automatically
});
</script>
{% endblock %}